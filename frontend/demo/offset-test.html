<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>getAbsoluteOffset ä¸€è‡´æ€§æµ‹è¯•</title>
    <style>
      body {
        font-family: 'Courier New', monospace;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-case {
        background: white;
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #4caf50;
      }
      .test-case.fail {
        border-left-color: #f44336;
      }
      .test-name {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 10px;
      }
      .test-result {
        display: grid;
        grid-template-columns: 150px 1fr;
        gap: 10px;
        margin: 5px 0;
        font-size: 14px;
      }
      .pass {
        color: #4caf50;
      }
      .fail {
        color: #f44336;
      }
      .editor {
        border: 1px solid #ddd;
        padding: 10px;
        min-height: 50px;
        margin: 10px 0;
        background: #fafafa;
      }
      .summary {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        min-width: 200px;
      }
    </style>
  </head>
  <body>
    <h1>getAbsoluteOffset ä¸ getTextContent ä¸€è‡´æ€§æµ‹è¯•</h1>
    <div class="summary" id="summary"></div>
    <div id="results"></div>

    <script type="module">
      // å¤åˆ¶ getTextContent å‡½æ•°
      function getTextContent(root) {
        let text = ''
        function traverse(node) {
          if (node.nodeType === Node.TEXT_NODE) {
            text += node.textContent || ''
          } else if (node.nodeType === Node.ELEMENT_NODE) {
            if (node.nodeName === 'BR') {
              // BRä¸äº§ç”Ÿå­—ç¬¦
            } else {
              for (const child of node.childNodes) {
                traverse(child)
              }
            }
            if (node.nodeName === 'DIV' && node !== root && node.nextSibling) {
              text += '\n'
            }
          }
        }
        traverse(root)
        return text
      }

      // å¤åˆ¶ä¿®æ”¹åçš„ getAbsoluteOffset å‡½æ•°
      function getAbsoluteOffset(node, offset, root) {
        let absoluteOffset = 0
        let found = false

        function traverse(currentNode) {
          if (found) return

          if (currentNode === node) {
            absoluteOffset += offset
            found = true
            return
          }

          if (currentNode.nodeType === Node.ELEMENT_NODE) {
            if (currentNode.nodeName === 'BR') {
              // âœ… ä¿®æ”¹ï¼šBRä¸äº§ç”Ÿä»»ä½•åç§»é‡
              // ä¸åšä»»ä½•æ“ä½œ
            } else {
              for (const child of currentNode.childNodes) {
                traverse(child)
                if (found) return
              }

              if (
                currentNode.nodeName === 'DIV' &&
                currentNode !== root &&
                currentNode.nextSibling
              ) {
                absoluteOffset += 1
              }
            }
          } else if (currentNode.nodeType === Node.TEXT_NODE) {
            absoluteOffset += currentNode.textContent?.length ?? 0
          }
        }

        traverse(root)
        return absoluteOffset
      }

      // æµ‹è¯•ç”¨ä¾‹
      const tests = [
        {
          name: 'æµ‹è¯•1: å•è¡Œæ–‡æœ¬ - å…‰æ ‡åœ¨æ–‡æœ¬ä¸­é—´',
          html: '<div>Hello World</div>',
          testPoints: [
            { desc: 'å…‰æ ‡åœ¨Hå‰', offset: 0 },
            { desc: 'å…‰æ ‡åœ¨Helloå', offset: 5 },
            { desc: 'å…‰æ ‡åœ¨è¡Œå°¾', offset: 11 },
          ],
        },
        {
          name: 'æµ‹è¯•2: å¤šè¡Œæ–‡æœ¬',
          html: '<div>Hello</div><div>World</div>',
          testPoints: [
            { desc: 'ç¬¬ä¸€è¡Œå¼€å¤´', offset: 0 },
            { desc: 'ç¬¬ä¸€è¡Œç»“å°¾', offset: 5 },
            { desc: 'ç¬¬äºŒè¡Œå¼€å¤´', offset: 6 },
            { desc: 'ç¬¬äºŒè¡Œç»“å°¾', offset: 11 },
          ],
        },
        {
          name: 'æµ‹è¯•3: åŒ…å«ç©ºè¡Œ',
          html: '<div>Hello</div><div><br></div><div>World</div>',
          testPoints: [
            { desc: 'Helloå', offset: 5 },
            { desc: 'ç©ºè¡Œä½ç½®', offset: 6 },
            { desc: 'Worldå‰', offset: 7 },
            { desc: 'Worldå', offset: 12 },
          ],
        },
        {
          name: 'æµ‹è¯•4: è¿ç»­ç©ºè¡Œ',
          html: '<div><br></div><div><br></div><div>Text</div>',
          testPoints: [
            { desc: 'ç¬¬ä¸€ä¸ªç©ºè¡Œ', offset: 0 },
            { desc: 'ç¬¬äºŒä¸ªç©ºè¡Œ', offset: 1 },
            { desc: 'Textå¼€å¤´', offset: 2 },
            { desc: 'Textç»“å°¾', offset: 6 },
          ],
        },
      ]

      const resultsContainer = document.getElementById('results')
      let passCount = 0
      let failCount = 0

      tests.forEach((test) => {
        const editor = document.createElement('div')
        editor.className = 'editor'
        editor.contentEditable = 'true'
        editor.innerHTML = test.html

        const textContent = getTextContent(editor)

        const testDiv = document.createElement('div')
        testDiv.className = 'test-case'

        let testHtml = `
        <div class="test-name">${test.name}</div>
        <div class="test-result">
          <span>HTML:</span>
          <code>${escapeHtml(test.html)}</code>
        </div>
        <div class="test-result">
          <span>Text Content:</span>
          <code>${escapeHtml(JSON.stringify(textContent))}</code>
        </div>
        <div class="test-result">
          <span>Text Length:</span>
          <code>${textContent.length}</code>
        </div>
      `

        let allPassed = true

        test.testPoints.forEach((point) => {
          const char = textContent[point.offset]
          const displayChar = char === '\n' ? '\\n' : char === undefined ? '(è¶…å‡ºèŒƒå›´)' : char

          // éªŒè¯ï¼štextContent[offset] åº”è¯¥å¯ä»¥è®¿é—®
          const passed = point.offset <= textContent.length

          if (passed) passCount++
          else {
            failCount++
            allPassed = false
          }

          testHtml += `
          <div class="test-result">
            <span class="${passed ? 'pass' : 'fail'}">${point.desc} (offset ${point.offset}):</span>
            <code class="${passed ? 'pass' : 'fail'}">
              ${passed ? `âœ… textContent[${point.offset}] = "${displayChar}"` : `âŒ è¶…å‡ºèŒƒå›´`}
            </code>
          </div>
        `
        })

        if (!allPassed) {
          testDiv.classList.add('fail')
        }

        testDiv.innerHTML = testHtml
        resultsContainer.appendChild(testDiv)
        editor.remove()
      })

      // æ˜¾ç¤ºæ‘˜è¦
      const summary = document.getElementById('summary')
      const totalTests = tests.reduce((sum, t) => sum + t.testPoints.length, 0)
      summary.innerHTML = `
      <h3>æµ‹è¯•æ‘˜è¦</h3>
      <div style="font-size: 16px; margin: 10px 0;">
        æ€»è®¡: ${totalTests}<br>
        <span class="pass">âœ… é€šè¿‡: ${passCount}</span><br>
        <span class="fail">âŒ å¤±è´¥: ${failCount}</span>
      </div>
      <div style="font-size: 20px; font-weight: bold; margin-top: 15px;">
        ${failCount === 0 ? '<span class="pass">å…¨éƒ¨é€šè¿‡! ğŸ‰</span>' : '<span class="fail">æœ‰æµ‹è¯•å¤±è´¥</span>'}
      </div>
    `

      function escapeHtml(text) {
        const div = document.createElement('div')
        div.textContent = text
        return div.innerHTML
      }
    </script>
  </body>
</html>
