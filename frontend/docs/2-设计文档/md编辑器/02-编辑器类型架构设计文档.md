# Markdown ç¼–è¾‘å™¨ç±»å‹æ¶æ„è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv1.0
> æ›´æ–°æ—¶é—´ï¼š2025-01-24
> æ–‡ä»¶ä½ç½®ï¼š`frontend/src/components/editor/types/editor.ts`

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [è®¾è®¡åŸåˆ™](#è®¾è®¡åŸåˆ™)
3. [ç±»å‹ç³»ç»Ÿåˆ†å±‚](#ç±»å‹ç³»ç»Ÿåˆ†å±‚)
4. [æ ¸å¿ƒç±»å‹è¯¦è§£](#æ ¸å¿ƒç±»å‹è¯¦è§£)
5. [å·¥å…·æ ç±»å‹ç³»ç»Ÿ](#å·¥å…·æ ç±»å‹ç³»ç»Ÿ)
6. [é…ç½®ç³»ç»Ÿ](#é…ç½®ç³»ç»Ÿ)
7. [ç±»å‹å…³ç³»å›¾](#ç±»å‹å…³ç³»å›¾)
8. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
9. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

---

## æ¶æ„æ¦‚è§ˆ

### æ•´ä½“è®¾è®¡æ€æƒ³

æœ¬ç¼–è¾‘å™¨çš„ç±»å‹ç³»ç»Ÿé‡‡ç”¨**åˆ†å±‚æ¶æ„**è®¾è®¡ï¼Œå°†ç¼–è¾‘å™¨çŠ¶æ€æŒ‰ç…§**ç”Ÿå‘½å‘¨æœŸ**å’Œ**èŒè´£**è¿›è¡Œåˆ†ç¦»ï¼Œç¡®ä¿ï¼š

- âœ… **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šä¸åŒç±»å‹çš„çŠ¶æ€æœ‰æ˜ç¡®çš„è¾¹ç•Œ
- âœ… **å¯ç»´æŠ¤æ€§**ï¼šæ¯å±‚ç‹¬ç«‹æ¼”åŒ–ï¼Œäº’ä¸å½±å“
- âœ… **å¯æµ‹è¯•æ€§**ï¼šæ¯å±‚å¯ä»¥å•ç‹¬æµ‹è¯•
- âœ… **ç±»å‹å®‰å…¨**ï¼šåˆ©ç”¨ TypeScript é«˜çº§ç‰¹æ€§é˜²æ­¢é”™è¯¯

### å››å±‚æ¶æ„æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 4: é…ç½®å±‚ (Configuration Layer)         â”‚
â”‚  - EditorConfig, AutoSaveConfig, ToolbarConfig â”‚
â”‚  - åˆå§‹åŒ–æ—¶ç¡®å®šï¼Œè¿è¡Œæ—¶ä¸å˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 3: é”™è¯¯å±‚ (Error Layer)                 â”‚
â”‚  - EditorErrorState, EditorErrorInfo           â”‚
â”‚  - å¼‚å¸¸æƒ…å†µä¸‹ä¸´æ—¶å‡ºç°                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 2: UI çŠ¶æ€å±‚ (UI State Layer)           â”‚
â”‚  - SelectionInfo, EditorUIState                â”‚
â”‚  - é¢‘ç¹å˜åŒ–ï¼Œä¸æŒä¹…åŒ–                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Layer 1: å†…å®¹å±‚ (Content Layer)               â”‚
â”‚  - EditorContent, EditorHistory                â”‚
â”‚  - å¿…é¡»æŒä¹…åŒ–ï¼Œç”¨æˆ·æ ¸å¿ƒæ•°æ®                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è®¾è®¡åŸåˆ™

### 1. èŒè´£åˆ†ç¦»ï¼ˆSeparation of Concernsï¼‰

**é—®é¢˜**ï¼šä¼ ç»Ÿçš„æ‰å¹³çŠ¶æ€è®¾è®¡ä¼šå¯¼è‡´ä¸åŒç”Ÿå‘½å‘¨æœŸçš„æ•°æ®æ··åœ¨ä¸€èµ·ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šæŒ‰ç”Ÿå‘½å‘¨æœŸå’Œç”¨é€”åˆ†å±‚ã€‚

```typescript
// âŒ ä¸å¥½çš„è®¾è®¡ï¼šæ‰€æœ‰çŠ¶æ€æ··åœ¨ä¸€èµ·
interface BadEditorState {
  content: string       // éœ€è¦æŒä¹…åŒ–
  title: string         // éœ€è¦æŒä¹…åŒ–
  cursorPos: number     // é¢‘ç¹å˜åŒ–ï¼Œä¸æŒä¹…åŒ–
  isSaving: boolean     // UI çŠ¶æ€
  lastSaved: Date       // å…ƒä¿¡æ¯
}

// âœ… å¥½çš„è®¾è®¡ï¼šæŒ‰èŒè´£åˆ†å±‚
interface EditorContent {
  content: string
  title: string
}

interface EditorUIState {
  selection: SelectionInfo
  isSaving: boolean
}
```

### 2. æ•°æ®å®Œæ•´æ€§ï¼ˆData Integrityï¼‰

ç¡®ä¿æ‰€æœ‰å¿…è¦çš„å…ƒæ•°æ®éƒ½æœ‰å®šä¹‰ï¼Œé¿å…éšå¼ä¾èµ–ã€‚

```typescript
// âœ… å®Œæ•´çš„é€‰åŒºä¿¡æ¯
export interface SelectionInfo {
  start: number
  end: number
  selectedText: string  // æ˜¾å¼å­˜å‚¨ï¼Œé¿å…é‡å¤è®¡ç®—
  isEmpty: boolean      // è®¡ç®—å±æ€§ï¼Œæå‡å¯è¯»æ€§
}
```

### 3. ç±»å‹å®‰å…¨ï¼ˆType Safetyï¼‰

åˆ©ç”¨ TypeScript çš„é«˜çº§ç‰¹æ€§ï¼ˆUnion Typesã€Discriminated Unionï¼‰é˜²æ­¢ç±»å‹é”™è¯¯ã€‚

```typescript
// âœ… ä½¿ç”¨ discriminated union ç¡®ä¿ç±»å‹å®‰å…¨
export type ToolbarItem = FloatingToolbarItem | BlockToolbarItem

// TypeScript èƒ½è‡ªåŠ¨æ¨æ–­ï¼š
if (item.action === 'bold') {
  // è¿™é‡Œ item çš„ç±»å‹è‡ªåŠ¨æ”¶çª„ä¸º InlineToolbarItem
  item.requiresSelection // âœ… ç±»å‹å®‰å…¨ï¼Œå€¼ä¸º true
}
```

### 4. æ‰©å±•æ€§ï¼ˆExtensibilityï¼‰

æ”¯æŒæ’ä»¶ç³»ç»Ÿã€æƒé™æ§åˆ¶ã€å›½é™…åŒ–ç­‰æ‰©å±•éœ€æ±‚ã€‚

```typescript
export interface EditorConfig {
  plugins?: EditorPlugin[]
  locale?: EditorLocales
  permissions?: PermissionConfig
}
```

---

## ç±»å‹ç³»ç»Ÿåˆ†å±‚

### Layer 1: å†…å®¹å±‚ - æ ¸å¿ƒæ•°æ®

**ç‰¹ç‚¹**ï¼š
- âœ… å¿…é¡»æŒä¹…åŒ–åˆ°æ•°æ®åº“
- âœ… ç”¨æˆ·æœ€å…³å¿ƒçš„æ•°æ®
- âœ… å˜åŒ–é¢‘ç‡ï¼šä½

#### 1.1 EditorContent - ç¼–è¾‘å™¨å†…å®¹

```typescript
export interface EditorContent {
  title: string       // æ–‡ç« æ ‡é¢˜
  content: string     // æ–‡ç« æ­£æ–‡ï¼ˆMarkdown æ ¼å¼ï¼‰
}
```

**è®¾è®¡è¦ç‚¹**ï¼š
- åªåŒ…å«çº¯å†…å®¹ï¼Œä¸åŒ…å« UI çŠ¶æ€
- å¯ä»¥ç›´æ¥åºåˆ—åŒ–ä¿å­˜åˆ°æ•°æ®åº“

#### 1.2 EditorHistory - ç¼–è¾‘å†å²

**æ ¸å¿ƒæ¦‚å¿µ**ï¼š
- **EditAction**ï¼šåŸå­æ“ä½œï¼ˆåº•å±‚ä¸å¯å†åˆ†ï¼‰
- **EditTransaction**ï¼šäº‹åŠ¡ï¼ˆç”¨æˆ·å¯æ„ŸçŸ¥çš„ä¸€æ¬¡æ“ä½œï¼‰
- **EditorHistory**ï¼šå†å²ç®¡ç†ï¼ˆæ’¤é”€/é‡åšæ ˆï¼‰

```typescript
// åŸå­æ“ä½œ
export interface EditAction {
  type: 'insert' | 'delete' | 'format' | 'replace'
  content?: string
  start?: number
  end?: number
  previousContent?: string
  timestamp: number
}

// äº‹åŠ¡ï¼ˆå¤šä¸ªåŸå­æ“ä½œçš„ç»„åˆï¼‰
export interface EditTransaction {
  id: string
  label: string              // ç”¨æˆ·å¯è¯»æè¿°ï¼š"è¾“å…¥æ–‡æœ¬"ã€"åº”ç”¨åŠ ç²—"
  actions: EditAction[]
  timestamp: number
}

// å†å²ç®¡ç†
export interface EditorHistory {
  transactions: EditTransaction[]
  currentIndex: number      // -1 è¡¨ç¤ºåˆå§‹çŠ¶æ€
}
```

**è®¾è®¡çµæ„Ÿ**ï¼šå‚è€ƒ VS Codeã€ProseMirrorã€Google Docs çš„ OT (Operational Transformation) æ¨¡å‹ã€‚

**ç¤ºä¾‹**ï¼š

```typescript
// ç”¨æˆ·è¿ç»­è¾“å…¥ "hello"
// â†“ äº§ç”Ÿ 5 ä¸ª EditAction
[
  { type: 'insert', content: 'h', timestamp: 1000 },
  { type: 'insert', content: 'e', timestamp: 1010 },
  { type: 'insert', content: 'l', timestamp: 1020 },
  { type: 'insert', content: 'l', timestamp: 1030 },
  { type: 'insert', content: 'o', timestamp: 1040 },
]

// â†“ è‡ªåŠ¨åˆå¹¶æˆ 1 ä¸ª EditTransactionï¼ˆæ—¶é—´çª—å£å†…ç›¸åŒç±»å‹æ“ä½œï¼‰
{
  id: 'txn-1',
  label: 'è¾“å…¥æ–‡æœ¬',
  actions: [/* ä¸Šé¢ 5 ä¸ª */],
  timestamp: 1000
}

// â†“ ç”¨æˆ·æ’¤é”€ 1 æ¬¡ Ctrl+Z
// æ•´ä¸ª "hello" éƒ½è¢«åˆ é™¤ï¼ˆè€Œä¸æ˜¯åªåˆ é™¤ 'o'ï¼‰
```

**æ’¤é”€/é‡åšé€»è¾‘**ï¼š

```typescript
// åˆå§‹çŠ¶æ€
transactions: []
currentIndex: -1  // æœªè¿›è¡Œä»»ä½•æ“ä½œ

// ç”¨æˆ·è¾“å…¥ "hello"
transactions: [txn1]
currentIndex: 0   // å¤„äº txn1 ä¹‹å

// ç”¨æˆ·å†è¾“å…¥ "world"
transactions: [txn1, txn2]
currentIndex: 1   // å¤„äº txn2 ä¹‹å

// ç”¨æˆ·æ’¤é”€ï¼ˆCtrl+Zï¼‰
transactions: [txn1, txn2]
currentIndex: 0   // å›åˆ° txn1 ä¹‹åï¼Œtxn2 çš„æ•ˆæœè¢«ç§»é™¤

// ç”¨æˆ·é‡åšï¼ˆCtrl+Yï¼‰
transactions: [txn1, txn2]
currentIndex: 1   // é‡æ–°åº”ç”¨ txn2

// ç”¨æˆ·åœ¨æ’¤é”€åè¿›è¡Œæ–°æ“ä½œï¼ˆè¾“å…¥ "!"ï¼‰
transactions: [txn1, txn3]  // txn2 è¢«æ¸…é™¤
currentIndex: 1
```

---

### Layer 2: UI çŠ¶æ€å±‚ - å®æ—¶ç•Œé¢çŠ¶æ€

**ç‰¹ç‚¹**ï¼š
- âŒ ä¸æŒä¹…åŒ–
- ğŸ”„ é¢‘ç¹å˜åŒ–ï¼ˆå…‰æ ‡ç§»åŠ¨ã€é€‰ä¸­æ–‡æœ¬ï¼‰
- ğŸ“Š UI ç»„ä»¶ç›´æ¥è®¢é˜…

#### 2.1 SelectionInfo - æ–‡æœ¬é€‰åŒºä¿¡æ¯

```typescript
export interface SelectionInfo {
  start: number           // é€‰ä¸­èµ·å§‹ä½ç½®ï¼ˆå­—ç¬¦ç´¢å¼•ï¼‰
  end: number             // é€‰ä¸­ç»“æŸä½ç½®
  selectedText: string    // é€‰ä¸­çš„æ–‡æœ¬å†…å®¹
  isEmpty: boolean        // æ˜¯å¦ä¸ºç©ºé€‰åŒºï¼ˆå…‰æ ‡ï¼‰
}
```

**è®¾è®¡è¦ç‚¹**ï¼š
- `isEmpty` æ˜¯è®¡ç®—å±æ€§ï¼ˆ`start === end`ï¼‰ï¼Œä½†æ˜¾å¼å­˜å‚¨ä»¥æå‡æ€§èƒ½
- `selectedText` å¯ä»¥ä» `content.substring(start, end)` è®¡ç®—ï¼Œä½†ç¼“å­˜é¿å…é‡å¤è®¡ç®—

#### 2.2 EditorUIState - å®Œæ•´ UI çŠ¶æ€

```typescript
export interface EditorUIState {
  selection: SelectionInfo
  isSaving: boolean       // æ˜¯å¦æ­£åœ¨ä¿å­˜
  isDirty: boolean        // æ˜¯å¦æœ‰æœªä¿å­˜çš„æ”¹åŠ¨
  isFocused: boolean      // ç¼–è¾‘å™¨æ˜¯å¦è·å¾—ç„¦ç‚¹
}
```

---

### Layer 3: é”™è¯¯å±‚ - å¼‚å¸¸çŠ¶æ€

**ç‰¹ç‚¹**ï¼š
- âš ï¸ ä¸´æ—¶çŠ¶æ€ï¼Œå‡ºç°é”™è¯¯æ—¶è®¾ç½®
- ğŸ”§ æ”¯æŒé”™è¯¯æ¢å¤å’Œé‡è¯•

#### 3.1 EditorErrorInfo - é”™è¯¯è¯¦æƒ…

```typescript
export interface EditorErrorInfo {
  code: string            // é”™è¯¯ä»£ç ï¼ˆå¦‚ 'SAVE_FAILED'ï¼‰
  message: string         // ç”¨æˆ·å¯è¯»çš„é”™è¯¯ä¿¡æ¯
  originalError?: Error   // åŸå§‹é”™è¯¯å¯¹è±¡ï¼ˆç”¨äºæ—¥å¿—ï¼‰
  timestamp: number       // é”™è¯¯å‘ç”Ÿæ—¶é—´
  recoverable: boolean    // æ˜¯å¦å¯ä»¥æ¢å¤ï¼ˆæ¯”å¦‚é‡è¯•ï¼‰
}
```

#### 3.2 EditorErrorState - é”™è¯¯çŠ¶æ€ç®¡ç†

```typescript
export interface EditorErrorState {
  hasError: boolean
  error?: EditorErrorInfo
}
```

---

### Layer 4: å®Œæ•´çŠ¶æ€ - ç»„åˆæ‰€æœ‰å±‚

```typescript
export interface EditorState
  extends EditorContent,
          EditorHistory,
          EditorUIState,
          EditorErrorState {

  // é¢å¤–å…ƒä¿¡æ¯
  lastSaved?: Date

  // è®¡ç®—å±æ€§çš„ç¼“å­˜ï¼ˆé¿å…é¢‘ç¹è®¡ç®—ï¼‰
  canUndo: boolean    // currentIndex >= 0
  canRedo: boolean    // currentIndex < transactions.length - 1
}
```

**è®¾è®¡è¦ç‚¹**ï¼š
- ä½¿ç”¨ `extends` ç»„åˆå¤šä¸ªæ¥å£ï¼ˆMixin æ¨¡å¼ï¼‰
- `canUndo`/`canRedo` æ˜¯ç¼“å­˜çš„è®¡ç®—å±æ€§ï¼Œé¿å…æ¯æ¬¡éƒ½ä» `history` è®¡ç®—

---

## å·¥å…·æ ç±»å‹ç³»ç»Ÿ

### è®¾è®¡ç›®æ ‡

1. **ç±»å‹å®‰å…¨**ï¼šä¸åŒå·¥å…·æ é¡¹æœ‰ä¸åŒçš„è¡Œä¸ºçº¦æŸ
2. **å¯æ‰©å±•**ï¼šæ˜“äºæ·»åŠ æ–°çš„æ“ä½œç±»å‹
3. **è‡ªæ–‡æ¡£åŒ–**ï¼šç±»å‹å®šä¹‰å³æ–‡æ¡£

### æ“ä½œç±»å‹åˆ†ç±»

```typescript
/**
 * æ“ä½œç±»å‹ä½“ç³»
 *
 * ToolbarType (æ‰€æœ‰æ“ä½œ)
 *   â”œâ”€â”€ FloatingToolbarType (æµ®åŠ¨å·¥å…·æ )
 *   â”‚     â”œâ”€â”€ InlineFormatType (è¡Œå†…æ ¼å¼)
 *   â”‚     â”‚     â”œâ”€â”€ bold, italic, code
 *   â”‚     â”‚     â”œâ”€â”€ highlight, link
 *   â”‚     â”‚     â””â”€â”€ ç‰¹ç‚¹ï¼šéœ€è¦é€‰ä¸­æ–‡æœ¬
 *   â”‚     â””â”€â”€ ParagraphFormatType (æ®µè½æ ¼å¼)
 *   â”‚           â”œâ”€â”€ heading1, heading2, heading3
 *   â”‚           â”œâ”€â”€ quote
 *   â”‚           â””â”€â”€ ç‰¹ç‚¹ï¼šä½œç”¨äºæ•´ä¸ªæ®µè½
 *   â””â”€â”€ BlockInsertType (å—çº§æ’å…¥)
 *         â”œâ”€â”€ codeBlock, image, table
 *         â”œâ”€â”€ video, embedLink, divider
 *         â””â”€â”€ ç‰¹ç‚¹ï¼šæ’å…¥æ–°å†…å®¹
 */
```

### å…·ä½“ç±»å‹å®šä¹‰

#### 1. InlineFormatType - è¡Œå†…æ ¼å¼

```typescript
export type InlineFormatType =
  | 'bold'       // **æ–‡å­—**
  | 'italic'     // *æ–‡å­—*
  | 'code'       // `æ–‡å­—`
  | 'highlight'  // ==æ–‡å­—==
  | 'link'       // [æ–‡å­—](url)
```

**ç‰¹ç‚¹**ï¼š
- âœ… éœ€è¦ç”¨æˆ·é€‰ä¸­æ–‡æœ¬æ‰èƒ½åº”ç”¨
- âœ… å‰ååŒ…è£¹è¯­æ³•
- âœ… æ”¯æŒ Toggleï¼ˆå·²æ ¼å¼åŒ–å¯ç§»é™¤ï¼‰

#### 2. ParagraphFormatType - æ®µè½æ ¼å¼

```typescript
export type ParagraphFormatType =
  | 'heading1'   // # æ–‡å­—
  | 'heading2'   // ## æ–‡å­—
  | 'heading3'   // ### æ–‡å­—
  | 'quote'      // > æ–‡å­—
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä½œç”¨äºæ•´ä¸ªæ®µè½ï¼ˆä¸éœ€è¦é€‰ä¸­å…¨æ–‡ï¼‰
- âœ… è¡Œé¦–å‰ç¼€è¯­æ³•
- âœ… å…‰æ ‡åœ¨ä»»ä½•ä½ç½®éƒ½å¯ä»¥åº”ç”¨

#### 3. BlockInsertType - å—çº§æ’å…¥

```typescript
export type BlockInsertType =
  | 'codeBlock'   // ```language\n...code...\n```
  | 'image'       // ![alt](url)
  | 'table'       // | col1 | col2 |
  | 'video'       // åµŒå…¥è§†é¢‘
  | 'embedLink'   // åµŒå…¥å¤–é“¾é¢„è§ˆ
  | 'divider'     // ---
```

**ç‰¹ç‚¹**ï¼š
- âœ… æ’å…¥æ–°çš„å—çº§å†…å®¹
- âœ… ç‹¬å ä¸€è¡Œæˆ–å¤šè¡Œ
- âœ… å¯èƒ½éœ€è¦é¢å¤–è¾“å…¥ï¼ˆå¦‚å›¾ç‰‡ URLï¼‰

### å·¥å…·æ é¡¹ç±»å‹

ä½¿ç”¨ **Discriminated Union** ç¡®ä¿ç±»å‹å®‰å…¨ï¼š

```typescript
// è¡Œå†…æ ¼å¼å·¥å…·æ é¡¹
interface InlineToolbarItem extends ToolbarItemBase {
  action: InlineFormatType
  requiresSelection: true   // âœ… å¼ºåˆ¶è¦æ±‚é€‰ä¸­æ–‡æœ¬
}

// æ®µè½æ ¼å¼å·¥å…·æ é¡¹
interface ParagraphToolbarItem extends ToolbarItemBase {
  action: ParagraphFormatType
  requiresSelection: false  // âœ… ä¸éœ€è¦é€‰ä¸­æ–‡æœ¬
}

// æµ®åŠ¨å·¥å…·æ é¡¹ï¼ˆUnion Typeï¼‰
export type FloatingToolbarItem = InlineToolbarItem | ParagraphToolbarItem

// å—çº§æ’å…¥å·¥å…·æ é¡¹
export interface BlockToolbarItem extends ToolbarItemBase {
  action: BlockInsertType
}

// æ‰€æœ‰å·¥å…·æ é¡¹
export type ToolbarItem = FloatingToolbarItem | BlockToolbarItem
```

**ç±»å‹å®‰å…¨ç¤ºä¾‹**ï¼š

```typescript
function handleToolbarClick(item: ToolbarItem) {
  // TypeScript èƒ½è‡ªåŠ¨æ¨æ–­ç±»å‹
  if (item.action === 'bold') {
    // è¿™é‡Œ item çš„ç±»å‹è‡ªåŠ¨æ”¶çª„ä¸º InlineToolbarItem
    console.log(item.requiresSelection) // âœ… true
  }

  if (item.action === 'heading1') {
    // è¿™é‡Œ item çš„ç±»å‹è‡ªåŠ¨æ”¶çª„ä¸º ParagraphToolbarItem
    console.log(item.requiresSelection) // âœ… false
  }
}
```

---

## é…ç½®ç³»ç»Ÿ

### AutoSaveConfig - è‡ªåŠ¨ä¿å­˜é…ç½®

**è®¾è®¡æ€è·¯**ï¼šé‡‡ç”¨**åˆ†å±‚ä¿å­˜ç­–ç•¥**

```typescript
export interface AutoSaveConfig {
  enabled: boolean

  // æœ¬åœ°ä¿å­˜ï¼ˆå¿«é€Ÿã€åŒæ­¥ï¼‰
  localStorageInterval?: number  // é»˜è®¤ 2000ms
  draftKey?: string              // é»˜è®¤ 'editor-draft'

  // æœåŠ¡å™¨ä¿å­˜ï¼ˆå¯é ã€å¼‚æ­¥ï¼‰
  apiUrl?: string
  apiInterval?: number           // é»˜è®¤ 10000ms

  // é‡è¯•é…ç½®
  maxRetries?: number
  retryDelay?: number

  // ä¿å­˜ç­–ç•¥
  storage: 'localStorage' | 'api' | 'both'  // æ¨è 'both'

  // é¡µé¢å¸è½½å¤„ç†
  saveOnBeforeUnload?: boolean
}
```

**æ¨èé…ç½®**ï¼š

```typescript
{
  enabled: true,
  storage: 'both',
  localStorageInterval: 2000,    // 2ç§’ä¿å­˜åˆ°æœ¬åœ°
  apiInterval: 10000,            // 10ç§’ä¿å­˜åˆ°æœåŠ¡å™¨
  maxRetries: 3,
  saveOnBeforeUnload: true
}
```

**å·¥ä½œåŸç†**ï¼š

```
ç”¨æˆ·è¾“å…¥
   â†“
æ¯ 2 ç§’ â†’ localStorageï¼ˆåŒæ­¥ã€å¿«é€Ÿï¼‰
   â†“
æ¯ 10 ç§’ â†’ APIï¼ˆå¼‚æ­¥ã€å¯é ï¼‰
   â†“
å…³é—­é¡µé¢å‰ â†’ å¼ºåˆ¶ä¿å­˜ä¸€æ¬¡
```

### EditorConfig - å®Œæ•´é…ç½®

```typescript
export interface EditorConfig {
  // åŸºç¡€é…ç½®
  title?: string
  content?: string
  placeholder?: string

  // åŠŸèƒ½å¼€å…³
  readOnly?: boolean
  spellCheck?: boolean

  // å·¥å…·æ é…ç½®
  toolbars?: {
    floating?: ToolbarConfig
    blockMenu?: ToolbarConfig
  }

  // è‡ªåŠ¨ä¿å­˜
  autoSave?: AutoSaveConfig

  // æ’¤é”€é‡åš
  historySize?: number           // é»˜è®¤ 50

  // æ’ä»¶ç³»ç»Ÿ
  plugins?: EditorPlugin[]

  // å›½é™…åŒ–
  locale?: EditorLocales

  // æƒé™æ§åˆ¶
  permissions?: PermissionConfig

  // æ ·å¼é…ç½®
  toolbarStyle?: ToolbarStyleConfig

  // é”™è¯¯å¤„ç†
  errorHandling?: ErrorHandlerConfig

  // äº‹ä»¶å›è°ƒ
  callbacks?: {
    onContentChange?: (content: string) => void
    onSave?: (state: EditorState) => void
    onError?: (error: EditorErrorInfo) => void
  }
}
```

### editor.config.ts - é»˜è®¤é…ç½®æ–‡ä»¶

**è®¾è®¡ç›®çš„**ï¼šå°†ç±»å‹å®šä¹‰ä¸é»˜è®¤å€¼åˆ†ç¦»ï¼Œæä¾›å¼€ç®±å³ç”¨çš„é…ç½®ã€‚

#### è®¾è®¡æ¨¡å¼ï¼šç±»å‹ä¸å€¼åˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç±»å‹å®šä¹‰ (editor.ts)                       â”‚
â”‚  - å®šä¹‰"å¯ä»¥é…ç½®ä»€ä¹ˆ"                       â”‚
â”‚  - TypeScript æ¥å£                          â”‚
â”‚  - ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é»˜è®¤é…ç½® (editor.config.ts)                â”‚
â”‚  - å®šä¹‰"é»˜è®¤æ˜¯ä»€ä¹ˆ"                         â”‚
â”‚  - è¿è¡Œæ—¶å®ä¾‹                               â”‚
â”‚  - å¼€ç®±å³ç”¨çš„å€¼                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·ä½¿ç”¨                                    â”‚
â”‚  - éƒ¨åˆ†è¦†ç›–é»˜è®¤å€¼                           â”‚
â”‚  - æ·±åº¦åˆå¹¶é…ç½®                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ–‡ä»¶å†…å®¹ç¤ºä¾‹

```typescript
// src/components/editor/types/editor.config.ts
import type { EditorConfig, FloatingToolbarItem } from './editor'

/**
 * é»˜è®¤æµ®åŠ¨å·¥å…·æ é…ç½®
 */
const defaultFloatingToolbarItems: FloatingToolbarItem[] = [
  // è¡Œå†…æ ¼å¼
  {
    id: 'bold',
    action: 'bold',
    icon: 'Bold',
    title: 'åŠ ç²— (Ctrl+B)',
    hotkey: 'Ctrl+B',
    requiresSelection: true,
  },
  {
    id: 'italic',
    action: 'italic',
    icon: 'Italic',
    title: 'æ–œä½“ (Ctrl+I)',
    hotkey: 'Ctrl+I',
    requiresSelection: true,
  },
  {
    id: 'code',
    action: 'code',
    icon: 'Code',
    title: 'è¡Œå†…ä»£ç ',
    requiresSelection: true,
  },
  {
    id: 'highlight',
    action: 'highlight',
    icon: 'Highlighter',
    title: 'é«˜äº®',
    requiresSelection: true,
  },
  {
    id: 'link',
    action: 'link',
    icon: 'Link',
    title: 'é“¾æ¥',
    requiresSelection: true,
  },

  // æ®µè½æ ¼å¼
  {
    id: 'heading1',
    action: 'heading1',
    icon: 'Heading1',
    title: 'ä¸€çº§æ ‡é¢˜',
    requiresSelection: false,
  },
  {
    id: 'heading2',
    action: 'heading2',
    icon: 'Heading2',
    title: 'äºŒçº§æ ‡é¢˜',
    requiresSelection: false,
  },
  {
    id: 'heading3',
    action: 'heading3',
    icon: 'Heading3',
    title: 'ä¸‰çº§æ ‡é¢˜',
    requiresSelection: false,
  },
  {
    id: 'quote',
    action: 'quote',
    icon: 'Quote',
    title: 'å¼•ç”¨',
    requiresSelection: false,
  },
]

/**
 * é»˜è®¤ç¼–è¾‘å™¨é…ç½®
 *
 * è¿™ä¸ªé…ç½®å¯ä»¥æ»¡è¶³ 80% çš„ä½¿ç”¨åœºæ™¯ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦è¦†ç›–ä»»ä½•é…ç½®é¡¹ã€‚
 */
export const defaultEditorConfig: EditorConfig = {
  // åŸºç¡€é…ç½®
  placeholder: 'å¼€å§‹ç¼–å†™ä½ çš„å†…å®¹...',
  readOnly: false,
  spellCheck: true,

  // å·¥å…·æ é…ç½®
  toolbars: {
    floating: {
      position: 'floating',
      items: defaultFloatingToolbarItems,
    },
  },

  // è‡ªåŠ¨ä¿å­˜é…ç½®ï¼ˆæ¨èï¼šæœ¬åœ° + æœåŠ¡å™¨åŒä¿é™©ï¼‰
  autoSave: {
    enabled: true,
    storage: 'both',
    localStorageInterval: 2000,    // 2ç§’ä¿å­˜åˆ°æœ¬åœ°
    apiInterval: 10000,            // 10ç§’ä¿å­˜åˆ°æœåŠ¡å™¨
    maxRetries: 3,
    retryDelay: 1000,
    draftKey: 'editor-draft',
    saveOnBeforeUnload: true,
  },

  // å†å²ç®¡ç†
  historySize: 50,  // æœ€å¤šä¿ç•™ 50 ä¸ªæ“ä½œ

  // å›½é™…åŒ–ï¼ˆé»˜è®¤ä¸­æ–‡ï¼‰
  locale: {
    bold: 'åŠ ç²—',
    italic: 'æ–œä½“',
    code: 'ä»£ç ',
    highlight: 'é«˜äº®',
    link: 'é“¾æ¥',
    heading1: 'ä¸€çº§æ ‡é¢˜',
    heading2: 'äºŒçº§æ ‡é¢˜',
    heading3: 'ä¸‰çº§æ ‡é¢˜',
    quote: 'å¼•ç”¨',
    codeBlock: 'ä»£ç å—',
    image: 'å›¾ç‰‡',
    table: 'è¡¨æ ¼',
    selectTextToFormat: 'è¯·å…ˆé€‰ä¸­æ–‡æœ¬',
    savingDraft: 'æ­£åœ¨ä¿å­˜è‰ç¨¿...',
    saveSuccess: 'ä¿å­˜æˆåŠŸ',
    saveFailed: 'ä¿å­˜å¤±è´¥',
  },

  // æƒé™æ§åˆ¶
  permissions: {
    canEdit: true,
    canUndo: true,
    canRedo: true,
  },

  // äº‹ä»¶å›è°ƒï¼ˆç”¨æˆ·å¯ä»¥è¦†ç›–ï¼‰
  callbacks: {
    onContentChange: undefined,
    onSave: undefined,
    onError: undefined,
  },
}
```

#### ä½¿ç”¨æ–¹å¼

**æ–¹å¼ 1ï¼šå®Œå…¨ä½¿ç”¨é»˜è®¤é…ç½®**

```typescript
import { useMarkdownEditor } from './composables/useMarkdownEditor'

// ä½¿ç”¨æ‰€æœ‰é»˜è®¤é…ç½®
const editor = useMarkdownEditor()
```

**æ–¹å¼ 2ï¼šéƒ¨åˆ†è¦†ç›–é…ç½®**

```typescript
import { useMarkdownEditor } from './composables/useMarkdownEditor'
import { defaultEditorConfig } from './types/editor.config'

// åªä¿®æ”¹éœ€è¦çš„éƒ¨åˆ†
const editor = useMarkdownEditor({
  ...defaultEditorConfig,
  placeholder: 'å†™ç‚¹ä»€ä¹ˆå§...',  // è‡ªå®šä¹‰å ä½ç¬¦
  autoSave: {
    ...defaultEditorConfig.autoSave,
    enabled: false,  // å…³é—­è‡ªåŠ¨ä¿å­˜
  },
  callbacks: {
    onContentChange: (content) => {
      console.log('å†…å®¹å˜åŒ–:', content)
    },
  },
})
```

**æ–¹å¼ 3ï¼šæ·±åº¦åˆå¹¶é…ç½®ï¼ˆå·¥å…·å‡½æ•°ï¼‰**

```typescript
// utils/configMerge.ts
import type { EditorConfig } from '../types/editor'
import { defaultEditorConfig } from '../types/editor.config'

/**
 * æ·±åº¦åˆå¹¶é…ç½®
 *
 * @param userConfig - ç”¨æˆ·æä¾›çš„é…ç½®
 * @returns åˆå¹¶åçš„å®Œæ•´é…ç½®
 */
export function mergeEditorConfig(
  userConfig: Partial<EditorConfig> = {}
): EditorConfig {
  return {
    ...defaultEditorConfig,
    ...userConfig,
    autoSave: {
      ...defaultEditorConfig.autoSave,
      ...userConfig.autoSave,
    },
    toolbars: {
      floating: userConfig.toolbars?.floating || defaultEditorConfig.toolbars?.floating,
      blockMenu: userConfig.toolbars?.blockMenu || defaultEditorConfig.toolbars?.blockMenu,
    },
    permissions: {
      ...defaultEditorConfig.permissions,
      ...userConfig.permissions,
    },
    callbacks: {
      ...defaultEditorConfig.callbacks,
      ...userConfig.callbacks,
    },
  }
}

// ä½¿ç”¨
const editor = useMarkdownEditor(
  mergeEditorConfig({
    title: 'æˆ‘çš„æ–‡ç« ',
    autoSave: { enabled: false },
  })
)
```

#### è®¾è®¡ä¼˜åŠ¿

| ä¼˜åŠ¿        | è¯´æ˜                    |
| --------- | --------------------- |
| **å¼€ç®±å³ç”¨**  | ç”¨æˆ·ä¸ä¼ é…ç½®ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼ˆ80%åœºæ™¯ï¼‰   |
| **çµæ´»å®šåˆ¶**  | ç”¨æˆ·å¯ä»¥è¦†ç›–ä»»ä½•é…ç½®é¡¹ï¼ˆ20%åœºæ™¯ï¼‰    |
| **é›†ä¸­ç®¡ç†**  | å…¨å±€é»˜è®¤å€¼ç»Ÿä¸€ç»´æŠ¤ï¼Œä¾¿äºè°ƒæ•´        |
| **ç±»å‹å®‰å…¨**  | TypeScript ç¼–è¯‘æ—¶æ£€æŸ¥é…ç½®å®Œæ•´æ€§ |
| **æ–‡æ¡£å³ä»£ç ** | é»˜è®¤é…ç½®æœ¬èº«å°±æ˜¯æœ€å¥½çš„ç¤ºä¾‹         |

#### é…ç½®éªŒè¯

**æ¨è**ï¼šåœ¨ `useMarkdownEditor` ä¸­éªŒè¯é…ç½®çš„å®Œæ•´æ€§

```typescript
// composables/useMarkdownEditor.ts
import { defaultEditorConfig } from '../types/editor.config'
import type { EditorConfig } from '../types/editor'

export function useMarkdownEditor(
  userConfig: Partial<EditorConfig> = {}
) {
  // 1. åˆå¹¶é…ç½®
  const config = mergeEditorConfig(userConfig)

  // 2. éªŒè¯é…ç½®
  validateConfig(config)

  // 3. åˆå§‹åŒ–ç¼–è¾‘å™¨
  // ...
}

function validateConfig(config: EditorConfig): void {
  // éªŒè¯è‡ªåŠ¨ä¿å­˜é…ç½®
  if (config.autoSave?.enabled && config.autoSave.storage === 'api') {
    if (!config.autoSave.apiUrl) {
      throw new Error(
        'å¯ç”¨ API è‡ªåŠ¨ä¿å­˜æ—¶å¿…é¡»æä¾› apiUrl é…ç½®'
      )
    }
  }

  // éªŒè¯å†å²å¤§å°
  if (config.historySize && config.historySize < 1) {
    throw new Error('historySize å¿…é¡»å¤§äº 0')
  }

  // éªŒè¯å·¥å…·æ é…ç½®
  if (config.toolbars?.floating) {
    if (config.toolbars.floating.items.length === 0) {
      console.warn('æµ®åŠ¨å·¥å…·æ æ²¡æœ‰é…ç½®ä»»ä½•æŒ‰é’®')
    }
  }
}
```

#### å¸¸è§é…ç½®åœºæ™¯

**åœºæ™¯ 1ï¼šè¯„è®ºç¼–è¾‘å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰**

```typescript
const commentEditorConfig: Partial<EditorConfig> = {
  placeholder: 'å†™ä¸‹ä½ çš„è¯„è®º...',
  autoSave: { enabled: false },  // è¯„è®ºä¸éœ€è¦è‡ªåŠ¨ä¿å­˜
  toolbars: {
    floating: {
      position: 'floating',
      items: [
        // åªä¿ç•™åŸºç¡€æ ¼å¼
        { id: 'bold', action: 'bold', requiresSelection: true },
        { id: 'italic', action: 'italic', requiresSelection: true },
        { id: 'link', action: 'link', requiresSelection: true },
      ],
    },
  },
  historySize: 10,  // è¯„è®ºå†å²ä¸éœ€è¦å¤ªå¤š
}
```

**åœºæ™¯ 2ï¼šåªè¯»é¢„è§ˆæ¨¡å¼**

```typescript
const previewConfig: Partial<EditorConfig> = {
  readOnly: true,
  permissions: {
    canEdit: false,
    canUndo: false,
    canRedo: false,
  },
  autoSave: { enabled: false },
}
```

**åœºæ™¯ 3ï¼šä¼ä¸šå†…ç½‘ï¼ˆæ— æœåŠ¡å™¨è‡ªåŠ¨ä¿å­˜ï¼‰**

```typescript
const intranetConfig: Partial<EditorConfig> = {
  autoSave: {
    enabled: true,
    storage: 'localStorage',  // åªç”¨æœ¬åœ°å­˜å‚¨
    localStorageInterval: 1000,  // 1ç§’ä¿å­˜
  },
}
```

#### å‚è€ƒèµ„æ–™

è¿™ç§"ç±»å‹ä¸å€¼åˆ†ç¦»"çš„è®¾è®¡æ¨¡å¼åœ¨ä¸šç•Œå¹¿æ³›ä½¿ç”¨ï¼š

- **Vue Router**: `RouteRecordRaw` (ç±»å‹) + `createRouter()` (å®ä¾‹)
- **Vite**: `UserConfig` (ç±»å‹) + `defineConfig()` (é…ç½®)
- **ESLint**: `.eslintrc` (ç±»å‹) + é»˜è®¤è§„åˆ™
- **Prettier**: `Options` (ç±»å‹) + `.prettierrc` (é»˜è®¤å€¼)

---

## ç±»å‹å…³ç³»å›¾

### çŠ¶æ€ç»„åˆå…³ç³»

```mermaid
graph TD
    EditorState --> EditorContent
    EditorState --> EditorHistory
    EditorState --> EditorUIState
    EditorState --> EditorErrorState

    EditorHistory --> EditTransaction
    EditTransaction --> EditAction

    EditorUIState --> SelectionInfo
    EditorErrorState --> EditorErrorInfo
```

### æ“ä½œç±»å‹ç»§æ‰¿å…³ç³»

```mermaid
graph TD
    ToolbarType --> FloatingToolbarType
    ToolbarType --> BlockInsertType

    FloatingToolbarType --> InlineFormatType
    FloatingToolbarType --> ParagraphFormatType

    InlineFormatType --> bold
    InlineFormatType --> italic
    InlineFormatType --> code
    InlineFormatType --> highlight
    InlineFormatType --> link

    ParagraphFormatType --> heading1
    ParagraphFormatType --> heading2
    ParagraphFormatType --> heading3
    ParagraphFormatType --> quote

    BlockInsertType --> codeBlock
    BlockInsertType --> image
    BlockInsertType --> table
    BlockInsertType --> video
    BlockInsertType --> embedLink
    BlockInsertType --> divider
```

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåˆå§‹åŒ–ç¼–è¾‘å™¨

```typescript
import type { EditorState, EditorConfig } from './types/editor'

const config: EditorConfig = {
  title: 'æˆ‘çš„æ–‡ç« ',
  content: '# æ ‡é¢˜\n\nè¿™æ˜¯å†…å®¹',
  autoSave: {
    enabled: true,
    storage: 'both',
    localStorageInterval: 2000,
    apiUrl: '/api/articles/auto-save',
    apiInterval: 10000,
  },
  callbacks: {
    onContentChange: (content) => {
      console.log('å†…å®¹å˜åŒ–:', content)
    },
  },
}

const initialState: EditorState = {
  // å†…å®¹å±‚
  title: config.title || '',
  content: config.content || '',

  // å†å²å±‚
  transactions: [],
  currentIndex: -1,

  // UI å±‚
  selection: { start: 0, end: 0, selectedText: '', isEmpty: true },
  isSaving: false,
  isDirty: false,
  isFocused: false,

  // é”™è¯¯å±‚
  hasError: false,

  // è®¡ç®—å±æ€§
  canUndo: false,
  canRedo: false,
}
```

### ç¤ºä¾‹ 2ï¼šå¤„ç†å·¥å…·æ ç‚¹å‡»

```typescript
import type { ToolbarItem, InlineFormatType } from './types/editor'

function handleToolbarClick(item: ToolbarItem, selection: SelectionInfo) {
  // TypeScript è‡ªåŠ¨ç±»å‹æ”¶çª„
  if (item.action === 'bold') {
    // item ç±»å‹: InlineToolbarItem
    if (!selection.isEmpty) {
      applyInlineFormat('bold', selection)
    } else {
      showWarning('è¯·å…ˆé€‰ä¸­æ–‡æœ¬')
    }
  }

  if (item.action === 'heading1') {
    // item ç±»å‹: ParagraphToolbarItem
    applyParagraphFormat('heading1')  // ä¸éœ€è¦é€‰ä¸­æ–‡æœ¬
  }

  if (item.action === 'codeBlock') {
    // item ç±»å‹: BlockToolbarItem
    insertBlock('codeBlock')
  }
}
```

### ç¤ºä¾‹ 3ï¼šæ’¤é”€/é‡åšé€»è¾‘

```typescript
import type { EditorHistory, EditTransaction } from './types/editor'

function undo(history: EditorHistory): EditorHistory {
  if (history.currentIndex < 0) {
    return history  // æ— æ³•æ’¤é”€
  }

  // è·å–è¦æ’¤é”€çš„äº‹åŠ¡
  const transaction = history.transactions[history.currentIndex]

  // åå‘åº”ç”¨äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œ
  for (const action of transaction.actions.reverse()) {
    revertAction(action)
  }

  // ç§»åŠ¨æŒ‡é’ˆ
  return {
    ...history,
    currentIndex: history.currentIndex - 1,
  }
}

function redo(history: EditorHistory): EditorHistory {
  if (history.currentIndex >= history.transactions.length - 1) {
    return history  // æ— æ³•é‡åš
  }

  // è·å–è¦é‡åšçš„äº‹åŠ¡
  const transaction = history.transactions[history.currentIndex + 1]

  // é‡æ–°åº”ç”¨äº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œ
  for (const action of transaction.actions) {
    applyAction(action)
  }

  // ç§»åŠ¨æŒ‡é’ˆ
  return {
    ...history,
    currentIndex: history.currentIndex + 1,
  }
}
```

### ç¤ºä¾‹ 4ï¼šè‡ªåŠ¨åˆå¹¶ç¼–è¾‘æ“ä½œ

```typescript
import type { EditTransaction, EditAction } from './types/editor'

const MERGE_WINDOW_MS = 500  // 500ms å†…çš„ç›¸åŒæ“ä½œè‡ªåŠ¨åˆå¹¶

function addTransaction(
  history: EditorHistory,
  newTransaction: EditTransaction
): EditorHistory {
  const lastTxn = history.transactions[history.currentIndex]

  // åˆ¤æ–­æ˜¯å¦å¯ä»¥åˆå¹¶
  const canMerge =
    lastTxn &&
    newTransaction.timestamp - lastTxn.timestamp < MERGE_WINDOW_MS &&
    newTransaction.label === lastTxn.label  // ç›¸åŒç±»å‹çš„æ“ä½œ

  if (canMerge) {
    // åˆå¹¶åˆ°æœ€åä¸€ä¸ªäº‹åŠ¡
    const mergedTxn: EditTransaction = {
      ...lastTxn,
      actions: [...lastTxn.actions, ...newTransaction.actions],
    }

    const newTransactions = [...history.transactions]
    newTransactions[history.currentIndex] = mergedTxn

    return {
      ...history,
      transactions: newTransactions,
    }
  } else {
    // æ·»åŠ æ–°äº‹åŠ¡ï¼ˆæ¸…é™¤ currentIndex ä¹‹åçš„å†å²ï¼‰
    const newTransactions = [
      ...history.transactions.slice(0, history.currentIndex + 1),
      newTransaction,
    ]

    return {
      ...history,
      transactions: newTransactions,
      currentIndex: newTransactions.length - 1,
    }
  }
}
```

---

## æœ€ä½³å®è·µ

### 1. çŠ¶æ€æ›´æ–°åŸåˆ™

**âœ… æ¨è**ï¼šä½¿ç”¨ä¸å¯å˜æ›´æ–°

```typescript
// å¥½çš„åšæ³•
const newState: EditorState = {
  ...state,
  content: newContent,
  isDirty: true,
}

// é¿å…
state.content = newContent  // âŒ å¯å˜æ›´æ–°
```

### 2. è®¡ç®—å±æ€§ç¼“å­˜

**âœ… æ¨è**ï¼šåœ¨ `EditorState` ä¸­ç¼“å­˜é¢‘ç¹è®¡ç®—çš„å±æ€§

```typescript
export interface EditorState {
  // ...
  canUndo: boolean  // âœ… ç¼“å­˜ï¼Œé¿å…æ¯æ¬¡éƒ½ä» history è®¡ç®—
  canRedo: boolean
}

// è®¡ç®—é€»è¾‘
function updateComputedProps(state: EditorState): EditorState {
  return {
    ...state,
    canUndo: state.currentIndex >= 0,
    canRedo: state.currentIndex < state.transactions.length - 1,
  }
}
```

### 3. ç±»å‹å®ˆå«

**âœ… æ¨è**ï¼šä½¿ç”¨ç±»å‹å®ˆå«å‡½æ•°

```typescript
function isInlineFormat(action: ToolbarType): action is InlineFormatType {
  return ['bold', 'italic', 'code', 'highlight', 'link'].includes(action)
}

function isParagraphFormat(action: ToolbarType): action is ParagraphFormatType {
  return ['heading1', 'heading2', 'heading3', 'quote'].includes(action)
}

// ä½¿ç”¨
if (isInlineFormat(action)) {
  // TypeScript çŸ¥é“ action æ˜¯ InlineFormatType
  applyInlineFormat(action)
}
```

### 4. é”™è¯¯å¤„ç†

**âœ… æ¨è**ï¼šä½¿ç”¨ `EditorErrorInfo` ç»Ÿä¸€é”™è¯¯æ ¼å¼

```typescript
function createError(
  code: string,
  message: string,
  originalError?: Error,
  recoverable: boolean = true
): EditorErrorInfo {
  return {
    code,
    message,
    originalError,
    timestamp: Date.now(),
    recoverable,
  }
}

// ä½¿ç”¨
try {
  await saveToServer(content)
} catch (error) {
  const editorError = createError(
    'SAVE_FAILED',
    'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥',
    error as Error,
    true  // å¯æ¢å¤
  )

  setState({
    ...state,
    hasError: true,
    error: editorError,
  })
}
```

### 5. é…ç½®éªŒè¯

**âœ… æ¨è**ï¼šéªŒè¯é…ç½®çš„å®Œæ•´æ€§

```typescript
function validateConfig(config: Partial<EditorConfig>): EditorConfig {
  // éªŒè¯è‡ªåŠ¨ä¿å­˜é…ç½®
  if (config.autoSave?.enabled && config.autoSave.storage === 'api') {
    if (!config.autoSave.apiUrl) {
      throw new Error('å¯ç”¨ API è‡ªåŠ¨ä¿å­˜æ—¶å¿…é¡»æä¾› apiUrl')
    }
  }

  // è®¾ç½®é»˜è®¤å€¼
  return {
    readOnly: false,
    spellCheck: true,
    historySize: 50,
    ...config,
  }
}
```

---

## æ€»ç»“

### æ ¸å¿ƒä¼˜åŠ¿

1. **ç±»å‹å®‰å…¨**ï¼šTypeScript ç¼–è¯‘æ—¶æ£€æŸ¥ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
2. **å¯ç»´æŠ¤**ï¼šåˆ†å±‚æ¸…æ™°ï¼Œæ¯å±‚ç‹¬ç«‹æ¼”åŒ–
3. **å¯æ‰©å±•**ï¼šæ’ä»¶ç³»ç»Ÿã€æƒé™æ§åˆ¶ã€å›½é™…åŒ–
4. **é«˜æ€§èƒ½**ï¼šè®¡ç®—å±æ€§ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—

### å‚è€ƒèµ„æ–™

- [ProseMirror æ¶æ„](https://prosemirror.net/docs/guide/)
- [VS Code ç¼–è¾‘å™¨æ¶æ„](https://code.visualstudio.com/api/extension-guides/overview)
- [Google Docs OT è®ºæ–‡](https://www.codecommit.com/blog/java/understanding-and-applying-operational-transformation)
- [TypeScript Discriminated Union](https://www.typescriptlang.org/docs/handbook/2/narrowing.html#discriminated-unions)

---

**æ–‡æ¡£ç»´æŠ¤è€…**ï¼šé¡¹ç›®å›¢é˜Ÿ
**æœ€åæ›´æ–°**ï¼š2025-01-24
