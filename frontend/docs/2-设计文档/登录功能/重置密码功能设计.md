# 重置密码功能设计

> **功能定位**：用户忘记密码时通过邮箱验证码重置密码
> **文档类型**：架构设计 + 实现指南

---

## 1. 用户流程

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 输入邮箱 + 发送验证码                                   │
│  ├── 用户输入邮箱地址                                            │
│  ├── 点击"发送验证码"按钮                                        │
│  ├── 后端检查邮箱是否已注册（必须存在）                           │
│  └── 发送验证码到邮箱                                            │
├─────────────────────────────────────────────────────────────────┤
│  Step 2: 输入验证码 + 新密码                                     │
│  ├── 用户输入验证码                                              │
│  ├── 用户输入新密码 + 确认密码                                    │
│  └── 提交重置请求                                                │
├─────────────────────────────────────────────────────────────────┤
│  Step 3: 重置成功                                                │
│  ├── 显示成功提示                                                │
│  └── 跳转到登录页                                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (Vue 3)                              │
├─────────────────────────────────────────────────────────────────┤
│  ForgotPasswordView.vue                                          │
│  ├── 邮箱输入 + 发送验证码按钮                                    │
│  ├── 验证码输入                                                  │
│  ├── 新密码 + 确认密码                                           │
│  └── 重置按钮                                                    │
│                                                                  │
│  复用组件：                                                       │
│  ├── useCountdown (倒计时)                                       │
│  ├── auth.css (页面样式)                                         │
│  ├── FormInput (输入框)                                          │
│  └── validators (表单验证)                                       │
└─────────────────────────────────────────────────────────────────┘
                          ↓ API 调用
┌─────────────────────────────────────────────────────────────────┐
│                        后端 (FastAPI)                            │
├─────────────────────────────────────────────────────────────────┤
│  POST /api/v1/auth/forgot-password                               │
│  ├── 检查邮箱是否存在（必须已注册）                                │
│  ├── 生成验证码 → 存 Redis                                       │
│  └── 后台发送邮件                                                 │
│                                                                  │
│  POST /api/v1/auth/reset-password                                │
│  ├── 校验验证码                                                  │
│  ├── 更新用户密码                                                │
│  └── 返回成功                                                    │
└─────────────────────────────────────────────────────────────────┘
                          ↓
┌───────────────────┐     ┌───────────────────┐
│      Redis        │     │    PostgreSQL     │
│  验证码临时存储    │     │    用户密码更新    │
└───────────────────┘     └───────────────────┘
```

---

## 3. 后端 API 设计

### 3.1 发送验证码 API

| 属性 | 值 |
|-----|---|
| 路径 | `POST /api/v1/auth/forgot-password` |
| 请求体 | `{ "email": "user@example.com" }` |
| 成功响应 | `{ "message": "验证码已发送" }` |
| 错误响应 | `USER_NOT_FOUND` - 邮箱未注册 |

**实现逻辑**：

```python
@router.post("/forgot-password", response_model=MessageResponse)
async def forgot_password(
    background_tasks: BackgroundTasks,
    email: EmailStr = Body(..., embed=True),
    db: Session = Depends(get_db),
):
    # 1. 检查邮箱是否存在（必须已注册）
    user = user_crud.get_user_by_email(db, email=email)
    if not user:
        raise UserNotFoundError(email=email)
    
    # 2. 生成验证码（复用现有逻辑）
    code = "".join(secrets.choice(string.digits) for _ in range(6))
    
    # 3. 存储到 Redis
    save_verification_code(email=email, code=code)
    
    # 4. 发送邮件（复用邮件模板或新建）
    background_tasks.add_task(
        EmailUtils.send_email,
        email_to=email,
        subject=f"{settings.APP_NAME} - 重置密码验证码",
        template_name="email_template.html",
        template_data={
            "app_name": settings.APP_NAME,
            "code": code,
            "expire_minutes": 5,
            "register_url": f"{settings.FRONTEND_URL}/login",
        },
    )
    
    return {"message": "验证码已发送"}
```

---

### 3.2 重置密码 API

| 属性 | 值 |
|-----|---|
| 路径 | `POST /api/v1/auth/reset-password` |
| 请求体 | `{ "email": "...", "code": "123456", "new_password": "..." }` |
| 成功响应 | `{ "message": "密码重置成功" }` |
| 错误响应 | `INVALID_VERIFICATION_CODE` / `USER_NOT_FOUND` |

**实现逻辑**：

```python
@router.post("/reset-password", response_model=MessageResponse)
async def reset_password(
    request: PasswordResetRequest,
    db: Session = Depends(get_db),
):
    # 1. 校验验证码
    if not verify_code(email=request.email, code=request.code):
        raise InvalidVerificationCodeError()
    
    # 2. 获取用户
    user = user_crud.get_user_by_email(db, email=request.email)
    if not user:
        raise UserNotFoundError(request.email)
    
    # 3. 更新密码
    user.password = get_password_hash(request.new_password)
    db.commit()
    
    return {"message": "密码重置成功"}
```

---

### 3.3 新增 Schema

**文件**：`app/schemas/user.py`

```python
class PasswordResetRequest(BaseModel):
    """重置密码请求"""
    email: EmailStr
    code: str = Field(..., min_length=6, max_length=6, description="6位验证码")
    new_password: str = Field(..., min_length=6, description="新密码")
    
    model_config = ConfigDict(
        json_schema_extra={
            "example": {
                "email": "user@example.com",
                "code": "123456",
                "new_password": "newpassword123"
            }
        }
    )
```

---

### 3.4 新增异常类（如果不存在）

**文件**：`app/core/exceptions.py`

```python
class UserNotFoundError(AppException):
    """用户不存在"""
    def __init__(self, email: str):
        super().__init__(
            status_code=status.HTTP_404_NOT_FOUND,
            code="USER_NOT_FOUND",
            message="该邮箱未注册",
        )
```

---

## 4. 前端页面设计

### 4.1 文件结构

```
src/
├── views/
│   └── ForgotPasswordView.vue   # 新建
├── api/
│   └── auth.api.ts              # 新增 2 个 API 函数
└── router/
    └── index.ts                 # 新增路由
```

---

### 4.2 页面组件设计

**文件**：`src/views/ForgotPasswordView.vue`

```vue
<script setup>
// 复用现有代码
import { useCountdown } from '@/composables/useCountdown'
import { useToastStore } from '@/stores/toast.store'
import { validateEmail, validatePassword, validateConfirmPassword, validateCode } from '@/utils/validators'
import FormInput from '@/components/FormInput.vue'

// 新增 API
import { forgotPasswordApi, resetPasswordApi } from '@/api/auth.api'

// 状态
const email = ref('')
const code = ref('')
const newPassword = ref('')
const confirmPassword = ref('')
const { countdown, start: startCountdown } = useCountdown(60)

// 方法
async function handleSendCode() {
  // 调用 forgotPasswordApi
}

async function handleReset() {
  // 调用 resetPasswordApi
}
</script>

<template>
  <div class="auth-container">
    <div class="auth-card">
      <!-- 头部 -->
      <div class="auth-header">
        <h1 class="auth-title">重置密码</h1>
        <p class="auth-subtitle">请输入您的邮箱验证身份</p>
      </div>

      <form @submit.prevent="handleReset">
        <!-- 邮箱 + 发送验证码（复用注册页结构） -->
        <!-- 验证码输入 -->
        <!-- 新密码 -->
        <!-- 确认密码 -->
        <!-- 重置按钮 -->
      </form>

      <!-- 返回登录 -->
      <div class="auth-footer">
        <router-link to="/login">返回登录</router-link>
      </div>
    </div>
  </div>
</template>

<style scoped>
/* 复用 auth.css，无需额外样式 */
</style>
```

---

### 4.3 新增 API 函数

**文件**：`src/api/auth.api.ts`

```ts
// 发送重置密码验证码
export async function forgotPasswordApi(email: string): Promise<{ message: string }> {
  const response = await api.post('/auth/forgot-password', { email })
  return response.data
}

// 重置密码
export interface ResetPasswordParams {
  email: string
  code: string
  new_password: string
}

export async function resetPasswordApi(params: ResetPasswordParams): Promise<{ message: string }> {
  const response = await api.post('/auth/reset-password', params)
  return response.data
}
```

---

### 4.4 路由配置

**文件**：`src/router/index.ts`

```ts
{
  path: '/forgot-password',
  name: 'ForgotPassword',
  component: () => import('@/views/ForgotPasswordView.vue'),
  meta: { requiresAuth: false }
}
```

---

## 5. 实现顺序

| 顺序  | 任务                                   | 预估时间  |
| --- | ------------------------------------ | ----- |
| 1   | 后端：新增 `PasswordResetRequest` Schema  | 5 分钟  |
| 2   | 后端：新增 `UserNotFoundError` 异常类（如果不存在） | 5 分钟  |
| 3   | 后端：实现 `POST /auth/forgot-password`   | 15 分钟 |
| 4   | 后端：实现 `POST /auth/reset-password`    | 15 分钟 |
| 5   | 后端：Swagger UI 测试                     | 10 分钟 |
| 6   | 前端：新增 API 函数                         | 5 分钟  |
| 7   | 前端：创建 `ForgotPasswordView.vue`       | 30 分钟 |
| 8   | 前端：添加路由                              | 2 分钟  |
| 9   | 端到端测试                                | 10 分钟 |

**总预估**：约 1.5 小时

---

## 6. 复用清单

| 复用项 | 来源 | 用途 |
|-------|------|------|
| `useCountdown` | `composables/useCountdown.ts` | 发送验证码倒计时 |
| `auth.css` | `styles/auth.css` | 页面样式 |
| `FormInput` | `components/FormInput.vue` | 输入框组件 |
| `validators` | `utils/validators.ts` | 表单验证函数 |
| `toast.store` | `stores/toast.store.ts` | 消息提示 |
| `save_verification_code` | `db/redis_client.py` | Redis 存储 |
| `verify_code` | `db/redis_client.py` | 验证码校验 |
| `email_template.html` | `templates/` | 邮件模板（可直接复用） |

---

## 7. 注意事项

### 7.1 与注册接口的区别

| 接口 | 邮箱检查逻辑 |
|-----|------------|
| `/auth/send-code`（注册） | 邮箱**不能**存在 |
| `/auth/forgot-password`（重置） | 邮箱**必须**存在 |

### 7.2 安全考虑

| 风险 | 防护措施 |
|-----|---------|
| 信息泄露 | 不透露"邮箱是否存在"（可选：统一返回"如果邮箱存在，验证码已发送"） |
| 暴力破解 | 验证码 5 分钟过期 + 前端 60 秒倒计时 |
| 重放攻击 | 验证成功后立即删除验证码 |

---

## 8. 测试检查清单

- [ ] 后端：邮箱不存在时返回正确错误
- [ ] 后端：验证码 5 分钟后过期
- [ ] 后端：验证码只能使用一次
- [ ] 后端：密码更新成功后可以登录
- [ ] 前端：发送验证码后倒计时 60 秒
- [ ] 前端：表单验证（邮箱格式、密码强度、确认密码一致）
- [ ] 前端：重置成功后跳转登录页
