# ç™»å½•åŠŸèƒ½æ¦‚è¦è®¾è®¡

> **æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
> **åˆ›å»ºæ—¥æœŸ**ï¼š2024-12-09  
> **éœ€æ±‚æ–‡æ¡£**ï¼š[ç™»å½•åŠŸèƒ½PRD](01-ç™»å½•åŠŸèƒ½PRD.md)  
> **çŠ¶æ€**ï¼šå¾…è¯„å®¡

---

## 1. è®¾è®¡ç›®æ ‡

åŸºäºéœ€æ±‚æ–‡æ¡£ï¼Œè®¾è®¡ç™»å½•åŠŸèƒ½çš„å‰ç«¯æŠ€æœ¯æ¶æ„ï¼Œå®ç°ï¼š

- ç”¨æˆ·ç™»å½•è¡¨å•åŠäº¤äº’
- JWT Token ç®¡ç†
- å…¨å±€ç™»å½•çŠ¶æ€ç®¡ç†
- è·¯ç”±æƒé™æ§åˆ¶

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„

```mermaid
flowchart TB
    subgraph Frontend["å‰ç«¯åº”ç”¨"]
        subgraph Views["é¡µé¢å±‚"]
            Login["Login.vue"]
        end

        subgraph Modules["æ¨¡å—å±‚"]
            LoginForm["LoginForm.vue"]
            AuthStore["auth.store.ts"]
        end

        subgraph Utils["å·¥å…·å±‚"]
            API["api.ts"]
            Token["token.ts"]
        end

        subgraph Router["è·¯ç”±å±‚"]
            Guard["è·¯ç”±å®ˆå«"]
        end
    end

    subgraph Backend["åç«¯ API"]
        AuthAPI["POST /api/auth/login"]
    end

    Login --> LoginForm
    LoginForm --> AuthStore
    AuthStore --> API
    AuthStore --> Token
    AuthStore --> Guard
    API --> AuthAPI
```

### 2.2 æ¨¡å—èŒè´£

| æ¨¡å—           | èŒè´£           | ä½ç½®                         |
| -------------- | -------------- | ---------------------------- |
| **Login.vue**  | ç™»å½•é¡µé¢å¸ƒå±€   | `views/Login.vue`            |
| **LoginForm**  | ç™»å½•è¡¨å•ç»„ä»¶   | `modules/auth/LoginForm.vue` |
| **auth.store** | ç™»å½•çŠ¶æ€ç®¡ç†   | `modules/auth/auth.store.ts` |
| **api.ts**     | HTTP è¯·æ±‚å°è£…  | `utils/api.ts`               |
| **token.ts**   | Token è¯»å†™å·¥å…· | `utils/token.ts`             |
| **è·¯ç”±å®ˆå«**   | æƒé™æ‹¦æˆª       | `router/index.ts`            |

---

## 3. è¯¦ç»†è®¾è®¡

### 3.1 Token ç®¡ç†ï¼ˆutils/token.tsï¼‰

**èŒè´£**ï¼šå°è£… localStorage æ“ä½œï¼Œç»Ÿä¸€ç®¡ç† JWT Token

```typescript
// æ¥å£å®šä¹‰
interface TokenService {
  getToken(): string | null
  setToken(token: string): void
  removeToken(): void
  isTokenValid(): boolean // å¯é€‰ï¼šæ£€æŸ¥è¿‡æœŸ
}
```

**å­˜å‚¨ä½ç½®**ï¼š`localStorage`  
**Key åç§°**ï¼š`auth_token`

### 3.2 API å°è£…ï¼ˆutils/api.tsï¼‰

**èŒè´£**ï¼šåˆ›å»º Axios å®ä¾‹ï¼Œé…ç½®è¯·æ±‚/å“åº”æ‹¦æˆªå™¨

```typescript
// æ ¸å¿ƒåŠŸèƒ½
1. åˆ›å»º Axios å®ä¾‹ï¼ˆbaseURLã€timeoutï¼‰
2. è¯·æ±‚æ‹¦æˆªå™¨ï¼šè‡ªåŠ¨æ·»åŠ  Authorization Header
3. å“åº”æ‹¦æˆªå™¨ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†ã€Token è¿‡æœŸå¤„ç†
```

**é…ç½®é¡¹**ï¼š

| é…ç½®    | å€¼                               |
| ------- | -------------------------------- |
| baseURL | `/api` æˆ–ç¯å¢ƒå˜é‡                |
| timeout | 10000ms                          |
| headers | `Content-Type: application/json` |

### 3.3 çŠ¶æ€ç®¡ç†ï¼ˆmodules/auth/auth.store.tsï¼‰

**èŒè´£**ï¼šä½¿ç”¨ Pinia ç®¡ç†å…¨å±€ç™»å½•çŠ¶æ€

```typescript
// State
interface AuthState {
  user: User | null // å½“å‰ç”¨æˆ·ä¿¡æ¯
  token: string | null // JWT Token
  isLoading: boolean // ç™»å½•ä¸­çŠ¶æ€
}

// Actions
interface AuthActions {
  login(email: string, password: string): Promise<void>
  logout(): void
  checkAuth(): void // æ£€æŸ¥æœ¬åœ° Token å¹¶æ¢å¤çŠ¶æ€
}

// Getters
interface AuthGetters {
  isLoggedIn: boolean // è®¡ç®—å±æ€§ï¼šæ˜¯å¦å·²ç™»å½•
}
```

**åˆå§‹åŒ–æµç¨‹**ï¼š

```
App å¯åŠ¨ â†’ checkAuth() â†’
  â”œâ”€ æœ‰ Token â†’ æ¢å¤ç”¨æˆ·çŠ¶æ€
  â””â”€ æ—  Token â†’ ä¿æŒæœªç™»å½•
```

### 3.4 ç™»å½•è¡¨å•ï¼ˆmodules/auth/LoginForm.vueï¼‰

**èŒè´£**ï¼šç™»å½•è¡¨å• UI + äº¤äº’é€»è¾‘

**ç»„ä»¶ç»“æ„**ï¼š

```vue
<template>
  <form @submit.prevent="handleSubmit">
    <!-- é‚®ç®±è¾“å…¥ -->
    <input v-model="email" type="text" />
    <span v-if="errors.email">{{ errors.email }}</span>

    <!-- å¯†ç è¾“å…¥ -->
    <input v-model="password" :type="showPassword ? 'text' : 'password'" />
    <button @click="togglePassword">ğŸ‘</button>
    <span v-if="errors.password">{{ errors.password }}</span>

    <!-- æäº¤æŒ‰é’® -->
    <button type="submit" :disabled="isLoading">
      {{ isLoading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
    </button>

    <!-- å…¨å±€é”™è¯¯ -->
    <div v-if="loginError">{{ loginError }}</div>
  </form>
</template>
```

**è¡¨å•éªŒè¯è§„åˆ™**ï¼š

| å­—æ®µ     | è§„åˆ™    | é”™è¯¯ä¿¡æ¯    |
| -------- | ------- | ----------- |
| email    | éç©º    | è¯·è¾“å…¥é‚®ç®±  |
| password | éç©º    | è¯·è¾“å…¥å¯†ç   |
| password | æœ€å°‘6ä½ | å¯†ç è‡³å°‘6ä½ |

### 3.5 ç™»å½•é¡µé¢ï¼ˆviews/Login.vueï¼‰

**èŒè´£**ï¼šé¡µé¢å¸ƒå±€ï¼Œç»„åˆ LoginForm ç»„ä»¶

```vue
<template>
  <div class="login-page">
    <div class="login-card">
      <h1>æ¬¢è¿ç™»å½•</h1>
      <LoginForm @success="handleLoginSuccess" />
      <p>æ²¡æœ‰è´¦å·ï¼Ÿ<router-link to="/register">å»æ³¨å†Œ</router-link></p>
    </div>
  </div>
</template>
```

### 3.6 è·¯ç”±å®ˆå«ï¼ˆrouter/index.tsï¼‰

**èŒè´£**ï¼šä¿æŠ¤éœ€è¦ç™»å½•çš„é¡µé¢

```typescript
// è·¯ç”±å…ƒä¿¡æ¯
meta: {
  requiresAuth: true
}

// å…¨å±€å‰ç½®å®ˆå«
router.beforeEach((to, from, next) => {
  const authStore = useAuthStore()

  if (to.meta.requiresAuth && !authStore.isLoggedIn) {
    next({ path: '/login', query: { redirect: to.fullPath } })
  } else {
    next()
  }
})
```

---

## 4. æ•°æ®æµè®¾è®¡

### 4.1 ç™»å½•æµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as LoginForm
    participant S as authStore
    participant A as api.ts
    participant T as token.ts
    participant B as åç«¯API

    U->>F: è¾“å…¥é‚®ç®±ã€å¯†ç 
    U->>F: ç‚¹å‡»ç™»å½•
    F->>S: login(email, password)
    S->>A: POST /auth/login
    A->>B: HTTP Request
    B-->>A: { access_token }
    A-->>S: è¿”å› Token
    S->>T: setToken(token)
    T-->>T: localStorage.setItem()
    S-->>F: ç™»å½•æˆåŠŸ
    F->>F: router.push('/')
```

### 4.2 é¡µé¢åˆ·æ–°æ¢å¤æµç¨‹

```mermaid
flowchart TD
    A["App.vue onMounted"] --> B["authStore.checkAuth()"]
    B --> C["token.getToken()"]
    C --> D{Token å­˜åœ¨?}
    D -->|null| E["ä¿æŒæœªç™»å½•çŠ¶æ€"]
    D -->|token| F["state.token = token"]
    F --> G["state.isLoggedIn = true"]
```

---

## 5. æ–‡ä»¶æ¸…å•

| æ–‡ä»¶è·¯å¾„                     | ç±»å‹ | è¯´æ˜           |
| ---------------------------- | ---- | -------------- |
| `utils/token.ts`             | æ–°å»º | Token ç®¡ç†å·¥å…· |
| `utils/api.ts`               | æ–°å»º | Axios å°è£…     |
| `modules/auth/index.ts`      | ä¿®æ”¹ | æ¨¡å—å…¥å£       |
| `modules/auth/auth.store.ts` | æ–°å»º | Pinia Store    |
| `modules/auth/LoginForm.vue` | æ–°å»º | ç™»å½•è¡¨å•ç»„ä»¶   |
| `views/Login.vue`            | æ–°å»º | ç™»å½•é¡µé¢       |
| `router/index.ts`            | ä¿®æ”¹ | æ·»åŠ è·¯ç”±å’Œå®ˆå« |

> [!NOTE]
> æ³¨ï¼šå­¦ä¹ é˜¶æ®µé‡‡ç”¨æ¨¡å—å†…èšçš„å¼€å‘æ¨¡å¼ï¼Œä»¥åéœ€è¦å…¨å±€å¤ç”¨å†æŠ½å–å‡ºæ¥
> ```
> src/modules/auth/
â”œâ”€â”€ token.ts          # Token è¯»å†™å·¥å…·
â”œâ”€â”€ api.ts            # Axios å®ä¾‹ + auth API
â”œâ”€â”€ auth.store.ts     # Pinia çŠ¶æ€ç®¡ç†
â”œâ”€â”€ LoginForm.vue     # ç™»å½•è¡¨å•ç»„ä»¶
â””â”€â”€ index.ts          # å¯¹å¤–æš´éœ²çš„ API
> ```


---

## 6. å¼€å‘é¡ºåº

```
1. utils/token.ts      â”€â”
                        â”œâ”€â–¶ åŸºç¡€è®¾æ–½å±‚
2. utils/api.ts        â”€â”˜

3. auth.store.ts       â”€â”€â”€â–¶ çŠ¶æ€ç®¡ç†å±‚

4. LoginForm.vue       â”€â”
                        â”œâ”€â–¶ UI å±‚
5. Login.vue           â”€â”˜

6. è·¯ç”±é…ç½® + å®ˆå«     â”€â”€â”€â–¶ è·¯ç”±å±‚
```

---

## 7. æŠ€æœ¯è¦ç‚¹

### 7.1 Pinia æŒä¹…åŒ–

ç™»å½•çŠ¶æ€éœ€è¦åœ¨é¡µé¢åˆ·æ–°åæ¢å¤ï¼Œæ–¹æ¡ˆï¼š

- **æ–¹æ¡ˆ A**ï¼šæ‰‹åŠ¨åœ¨ `checkAuth()` ä¸­ä» localStorage è¯»å–
- **æ–¹æ¡ˆ B**ï¼šä½¿ç”¨ `pinia-plugin-persistedstate` æ’ä»¶

**æ¨è**ï¼šæ–¹æ¡ˆ Aï¼ˆç®€å•ï¼Œæ˜“ç†è§£ï¼‰

### 7.2 Token è¿‡æœŸå¤„ç†

å“åº”æ‹¦æˆªå™¨ä¸­æ£€æµ‹ 401 çŠ¶æ€ç ï¼š

```typescript
if (response.status === 401) {
  authStore.logout()
  router.push('/login')
}
```

### 7.3 ç™»å½•æˆåŠŸè·³è½¬

æ”¯æŒè·³è½¬åˆ°åŸé¡µé¢ï¼ˆä»è·¯ç”±å®ˆå«æ‹¦æˆªçš„æƒ…å†µï¼‰ï¼š

```typescript
const redirect = route.query.redirect as string
router.push(redirect || '/')
```

---

## 8. é£é™©ä¸çº¦æŸ

| é£é™©ç‚¹                       | åº”å¯¹ç­–ç•¥                                     |
| ---------------------------- | -------------------------------------------- |
| Token å­˜ localStorage ä¸å®‰å…¨ | æ•™å­¦é¡¹ç›®å¯æ¥å—ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®® httpOnly Cookie |
| æ—  Token åˆ·æ–°æœºåˆ¶            | åç»­å¯æ‰©å±• Refresh Token                     |
| æ— å¯†ç åŠ å¯†                   | ä¾èµ– HTTPS ä¼ è¾“åŠ å¯†                          |
