# 邮件验证码发送功能设计

> **功能定位**：用户注册/密码重置时的邮箱验证
> **技术栈**：FastAPI + fastapi-mail + Redis + Jinja2

---

## 1. 设计目标

| 目标 | 说明 |
|-----|------|
| **安全性** | 验证码有时效、单次有效、防暴力破解 |
| **用户体验** | 后台异步发送、不阻塞请求响应 |
| **可维护性** | HTML 模板分离、配置外部化 |

---

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│  前端：发送验证码请求                                        │
│  POST /api/v1/auth/send-code { email: "user@example.com" }  │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│  后端 API：auth.py                                          │
│  1. 验证邮箱格式                                            │
│  2. 检查邮箱是否已注册（注册场景：不能存在）                  │
│  3. 生成 6 位随机验证码                                      │
│  4. 存储到 Redis（设置 5 分钟过期）                          │
│  5. 后台任务发送邮件                                         │
│  6. 立即返回成功响应                                         │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌───────────────────┐     ┌───────────────────┐
│  Redis            │     │  SMTP 邮件服务    │
│  存储验证码       │     │  异步发送邮件     │
│  key: verify:email│     │  (BackgroundTasks)│
│  TTL: 5分钟       │     │                   │
└───────────────────┘     └───────────────────┘
```

---

## 3. 核心技术点

### 3.1 为什么用 Redis 存储验证码？

| 方案 | 优点 | 缺点 |
|-----|------|------|
| **Redis** ✅ | 原生 TTL 过期、高性能、分布式支持 | 需要额外服务 |
| 数据库 | 无额外依赖 | 需手动清理过期数据 |
| 内存变量 | 简单 | 重启丢失、多进程不共享 |

**Redis 命令**：
```python
# 存储：SETEX key seconds value
client.setex("verify_code:user@example.com", 300, "123456")

# 读取：GET key
code = client.get("verify_code:user@example.com")

# 删除：DEL key（验证成功后删除，防止重放）
client.delete("verify_code:user@example.com")
```

---

### 3.2 后台异步发送邮件

```python
from fastapi import BackgroundTasks

@router.post("/send-code")
async def send_verification_code(
    background_tasks: BackgroundTasks,
    email: EmailStr,
    ...
):
    # 同步操作：验证、生成码、存 Redis
    ...
    
    # 异步操作：发送邮件（不阻塞响应）
    background_tasks.add_task(
        EmailUtils.send_email,
        email_to=email,
        subject="验证码",
        template_name="email_template.html",
        template_data={...}
    )
    
    # 立即返回（不等邮件发完）
    return {"message": "验证码已发送"}
```

**为什么用 BackgroundTasks？**
- 邮件发送可能耗时 2-5 秒
- 用户不需要等待邮件发完才能继续操作
- FastAPI 内置方案，无需引入 Celery

---

### 3.3 验证码安全设计

| 安全措施 | 实现方式 |
|---------|---------|
| **时效性** | Redis TTL 5 分钟自动过期 |
| **单次有效** | 验证成功后立即删除 |
| **随机性** | `secrets` 模块生成（非 `random`） |
| **信息隐藏** | 不透露"邮箱是否存在"给攻击者 |

```python
import secrets
import string

# 使用 secrets 而非 random（密码学安全）
code = "".join(secrets.choice(string.digits) for _ in range(6))
```

---

### 3.4 邮件 HTML 模板

**模板位置**：`app/templates/email_template.html`

**设计要点**：

| 要点 | 说明 |
|-----|------|
| **表格布局** | 邮件客户端对 CSS 支持有限，用 `<table>` 最可靠 |
| **内联样式** | 不要用外部 CSS，部分客户端会过滤 |
| **600px 宽度** | 邮件最佳显示宽度 |
| **Jinja2 变量** | `{{ code }}`、`{{ expire_minutes }}` 动态渲染 |

```html
<!-- 突出显示验证码 -->
<span style="font-size: 28px; font-weight: bold; color: #3b5998;">
  {{ code }}
</span>

<!-- 突出显示有效期 -->
<span style="color: #e53e3e; font-weight: bold;">
  {{ expire_minutes }} 分钟
</span>
```

---

## 4. 文件结构

```
app/
├── api/v1/endpoints/
│   └── auth.py              # API 端点
├── core/
│   ├── config.py            # 邮件服务配置
│   └── email_utils.py       # 邮件发送工具类
├── db/
│   └── redis_client.py      # Redis 验证码操作
└── templates/
    └── email_template.html  # 邮件 HTML 模板
```

---

## 5. 配置项

在 `.env` 或 `config.py` 中配置：

```env
# SMTP 配置
MAIL_USERNAME=your-email@example.com
MAIL_PASSWORD=your-app-password
MAIL_FROM=your-email@example.com
MAIL_PORT=587
MAIL_SERVER=smtp.example.com
MAIL_STARTTLS=true
MAIL_SSL_TLS=false

# Redis 配置
REDIS_HOST=localhost
REDIS_PORT=6379
```

---

## 6. 验证码校验流程

```python
def verify_code(email: str, code: str) -> bool:
    """验证用户提交的验证码
    
    流程：
    1. 从 Redis 获取存储的验证码
    2. 比对用户提交的验证码
    3. 匹配成功 → 删除 Redis 中的验证码（防重放）
    4. 返回验证结果
    """
    stored_code = get_verification_code(email)
    if stored_code and stored_code == code:
        delete_verification_code(email)  # 验证成功后删除
        return True
    return False
```

---

## 7. 前端配合

| 前端职责 | 说明 |
|---------|------|
| 倒计时 | 发送成功后 60 秒内禁止重发 |
| 邮箱校验 | 发送前校验邮箱格式 |
| 错误处理 | 显示"邮箱已存在"等错误 |

```ts
// 使用 useCountdown composable
const { countdown, start } = useCountdown(60)

// 发送成功后启动倒计时
await sendCodeApi(email)
start()
```

---

## 8. 相关文件

| 文件 | 说明 |
|-----|------|
| [auth.py](file:///Users/limq/00-app/fastapi_blog/app/api/v1/endpoints/auth.py) | 发送验证码 API |
| [redis_client.py](file:///Users/limq/00-app/fastapi_blog/app/db/redis_client.py) | Redis 验证码操作 |
| [email_utils.py](file:///Users/limq/00-app/fastapi_blog/app/core/email_utils.py) | 邮件发送工具类 |
| [email_template.html](file:///Users/limq/00-app/fastapi_blog/app/templates/email_template.html) | 邮件 HTML 模板 |
| [useCountdown.ts](file:///Users/limq/00-app/fastapi_blog/frontend/src/composables/useCountdown.ts) | 前端倒计时 composable |
