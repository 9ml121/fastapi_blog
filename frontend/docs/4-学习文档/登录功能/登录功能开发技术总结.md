# 登录功能开发完整技术总结

> 本文档总结登录功能前端开发的完整流程，按**前端 UI** 和 **API 对接**两部分组织，涵盖 Step 1-11 所有开发步骤的技术重难点。

---

## 开发步骤总览

| 阶段 | 步骤 | 任务 | 核心技术 |
|------|------|------|----------|
| **前端 UI** | Step 1 | 登录页面基础布局 | Vue Router、Flexbox 居中 |
| | Step 2 | 品牌 Logo 组件 | Vue 组件封装、Props |
| | Step 3 | 登录卡片容器 | CSS 盒模型、box-shadow |
| | Step 4 | 输入框组件 | v-model、slot 插槽 |
| | Step 5 | 密码可见性切换 | ref、条件渲染 |
| | Step 6 | 登录按钮与状态 | 加载动画、:disabled |
| | Step 7 | 表单验证 | HTML5 原生验证 |
| | Step 8 | 错误提示显示 | 条件渲染 |
| **API 对接** | Step 9 | 登录 API 对接 | Pinia、async/await、try/catch |
| | Step 10 | 登录成功跳转 | router.push 编程式导航 |
| | Step 11 | 路由守卫保护 | beforeEach、meta |

---

# 第一部分：前端 UI 开发

## Step 1：登录页面基础布局

### 技术要点

**1. Vue Router 路由配置**

```typescript
// src/router/index.ts
const routes = [
  {
    path: '/login',
    name: 'Login',
    component: () => import('@/views/LoginView.vue')  // 懒加载
  }
]
```

**2. Flexbox 垂直水平居中**

```css
.auth-container {
  min-height: 100vh;          /* 占满视口高度 */
  display: flex;
  flex-direction: column;
  justify-content: center;    /* 垂直居中 */
  align-items: center;        /* 水平居中 */
}
```

---

## Step 2-3：品牌 Logo 和卡片容器组件

### 技术要点

**1. Vue 组件 Props 定义**

```typescript
// BrandLogo.vue
interface Props {
  size?: 'small' | 'medium' | 'large'
  showName?: boolean
  direction?: 'horizontal' | 'vertical'
}

const props = withDefaults(defineProps<Props>(), {
  size: 'medium',
  showName: true,
  direction: 'horizontal'
})
```

**2. CSS 变量与设计 Token**

```css
:root {
  --color-bg-card: #ffffff;
  --color-shadow: rgba(0, 0, 0, 0.1);
  --border-radius-lg: 16px;
}

.auth-card {
  background: var(--color-bg-card);
  border-radius: var(--border-radius-lg);
  box-shadow: 0 10px 30px var(--color-shadow);
}
```

---

## Step 4：输入框组件

### 技术要点

**1. v-model 双向绑定实现**

```typescript
// FormInput.vue
const model = defineModel<string>()  // Vue 3.4+ 语法

// 等价于：
// const props = defineProps<{ modelValue: string }>()
// const emit = defineEmits<{ 'update:modelValue': [value: string] }>()
```

**2. slot 插槽实现图标**

```html
<!-- 组件模板 -->
<div class="input-wrapper">
  <span class="prefix"><slot name="prefix" /></span>
  <input v-model="model" />
  <span class="suffix"><slot name="suffix" /></span>
</div>

<!-- 使用时 -->
<FormInput v-model="email">
  <template #prefix><Mail :size="20" /></template>
</FormInput>
```

---

## Step 5：密码可见性切换

### 技术要点

**条件渲染与动态属性绑定**

```typescript
const showPassword = ref(false)
const togglePassword = () => {
  showPassword.value = !showPassword.value
}
```

```html
<FormInput
  :type="showPassword ? 'text' : 'password'"
>
  <template #suffix>
    <Eye v-if="showPassword" @click="togglePassword" />
    <EyeOff v-else @click="togglePassword" />
  </template>
</FormInput>
```

---

## Step 6：登录按钮与加载状态

### 技术要点

**1. 按钮禁用状态**

```html
<button :disabled="isLoading" type="submit">
  <Loader2 v-if="isLoading" class="loading-icon" />
  <span>{{ isLoading ? '登录中...' : '登 录' }}</span>
</button>
```

**2. CSS 旋转动画**

```css
.loading-icon {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
```

---

## Step 7-8：表单验证与错误提示

### 技术要点

**1. HTML5 原生验证**

```html
<input type="email" required />    <!-- 邮箱格式 + 必填 -->
<input type="password" required /> <!-- 必填 -->
```

**2. 错误提示显示**

```typescript
const errorMessage = ref('')
```

```html
<div v-if="errorMessage" class="error-message">
  {{ errorMessage }}
</div>
```

```css
.error-message {
  color: var(--color-error);
  background-color: var(--color-bg-error);
  padding: 0.5rem;
  border-radius: 8px;
  text-align: center;
}
```

---

# 第二部分：API 对接

## 认证架构概述

### Token 存储机制

```
登录成功
    ↓
同时保存到两个位置：
├── localStorage  → 持久化（刷新页面不丢失）
└── Pinia Store   → 响应式（驱动 UI 更新）
```

### 文件结构

```
src/modules/auth/
├── api.ts          # Axios 实例 + 登录 API
├── auth.store.ts   # Pinia Store
├── token.ts        # Token 读写工具
└── index.ts        # 模块入口
```

---

## Step 9：登录 API 对接

### 技术要点

**1. OAuth2 表单提交格式**

后端使用 OAuth2PasswordRequestForm，要求 `application/x-www-form-urlencoded`：

```typescript
export async function loginApi(params: LoginParams): Promise<LoginResponse> {
  const formData = new URLSearchParams()
  formData.append('username', params.username)
  formData.append('password', params.password)

  const response = await api.post('/auth/login', formData, {
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
  })
  return response.data
}
```

**2. Pinia Store 调用**

```typescript
// LoginView.vue
import { useAuthStore } from '@/modules/auth'

const authStore = useAuthStore()

const handleLogin = async () => {
  errorMessage.value = ''
  isLoading.value = true
  try {
    await authStore.login({
      username: username.value,
      password: password.value
    })
    router.push('/')
  } catch (error) {
    errorMessage.value = '用户名或密码错误'
  } finally {
    isLoading.value = false
  }
}
```

**3. ⚠️ 踩坑点：401 响应拦截器**

问题：登录失败返回 401，拦截器误判为 Token 过期，触发重定向导致错误提示消失。

解决方案：

```typescript
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response?.status === 401) {
      // 排除登录接口
      const isLoginRequest = error.config?.url?.includes('/auth/login')
      if (!isLoginRequest) {
        removeToken()
        window.location.href = '/login'
      }
    }
    return Promise.reject(error)
  }
)
```

---

## Step 10：登录成功跳转

### 技术要点

**Vue Router 编程式导航**

```typescript
import { useRouter } from 'vue-router'

const router = useRouter()

// 登录成功后
router.push('/')           // 跳转首页
router.push('/dashboard')  // 跳转指定页面
router.push({ name: 'Home' })  // 使用路由名称
```

---

## Step 11：路由守卫保护

### 技术要点

**1. 路由 meta 标记**

```typescript
{
  path: '/markdown',
  component: MarkdownEditor,
  meta: { requiresAuth: true }  // 需要登录
}
```

**2. 全局前置守卫（Vue Router 4.x 新写法）**

```typescript
import { getToken } from '@/modules/auth/token'

router.beforeEach((to, from) => {
  if (to.meta.requiresAuth && !getToken()) {
    return '/login'  // 重定向到登录页
  }
  // 不返回 = 放行
})
```

**3. 返回值含义**

| 返回值 | 效果 |
|--------|------|
| 不返回 / `undefined` | 放行 |
| `'/path'` | 重定向 |
| `false` | 取消跳转 |

---

# 附录：常见问题排查

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 错误提示一闪而过 | 401 触发拦截器重定向 | 排除登录接口的 401 |
| Loading 看不到 | 网络太快 | DevTools 限速测试 |
| 刷新后登录状态丢失 | 只存 Pinia 没存 localStorage | 双重存储 |
| 访问 / 页面空白 | 缺少 redirect 或默认子路由 | 添加 redirect |
| beforeEach 卡住 | 忘记放行 | 确保所有分支都有返回 |

---

## 相关文件

| 文件 | 用途 |
|------|------|
| [LoginView.vue](file:///Users/limq/00-app/fastapi_blog/frontend/src/views/LoginView.vue) | 登录页面 |
| [api.ts](file:///Users/limq/00-app/fastapi_blog/frontend/src/modules/auth/api.ts) | API 封装 |
| [auth.store.ts](file:///Users/limq/00-app/fastapi_blog/frontend/src/modules/auth/auth.store.ts) | 状态管理 |
| [token.ts](file:///Users/limq/00-app/fastapi_blog/frontend/src/modules/auth/token.ts) | Token 工具 |
| [router/index.ts](file:///Users/limq/00-app/fastapi_blog/frontend/src/router/index.ts) | 路由配置 |
