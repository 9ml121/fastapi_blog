<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>getNodeAndOffset å®Œæ•´æµ‹è¯•</title>
    <style>
      body {
        font-family: 'Courier New', monospace;
        padding: 20px;
        background: #f5f5f5;
      }
      .test-case {
        background: white;
        margin: 20px 0;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #4caf50;
      }
      .test-case.fail {
        border-left-color: #f44336;
      }
      .test-name {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 10px;
      }
      .test-result {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 10px;
        margin: 5px 0;
        font-size: 14px;
      }
      .pass {
        color: #4caf50;
      }
      .fail {
        color: #f44336;
      }
      .summary {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        min-width: 200px;
      }
    </style>
  </head>
  <body>
    <h1>getNodeAndOffset å®Œæ•´æµ‹è¯•ï¼ˆå¾€è¿”ä¸€è‡´æ€§ï¼‰</h1>
    <div class="summary" id="summary"></div>
    <div id="results"></div>

    <script type="module">
      // å¤åˆ¶ä¿®æ”¹åçš„ä¸‰ä¸ªå‡½æ•°
      function getTextContent(root) {
        let text = ''
        function traverse(node) {
          if (node.nodeType === Node.TEXT_NODE) {
            text += node.textContent || ''
          } else if (node.nodeType === Node.ELEMENT_NODE) {
            if (node.nodeName === 'BR') {
              // BRä¸äº§ç”Ÿå­—ç¬¦
            } else {
              for (const child of node.childNodes) {
                traverse(child)
              }
            }
            if (node.nodeName === 'DIV' && node !== root && node.nextSibling) {
              text += '\n'
            }
          }
        }
        traverse(root)
        return text
      }

      function getAbsoluteOffset(node, offset, root) {
        let absoluteOffset = 0
        let found = false

        function traverse(currentNode) {
          if (found) return

          if (currentNode === node) {
            absoluteOffset += offset
            found = true
            return
          }

          if (currentNode.nodeType === Node.ELEMENT_NODE) {
            if (currentNode.nodeName === 'BR') {
              // BRä¸äº§ç”Ÿä»»ä½•åç§»é‡
            } else {
              for (const child of currentNode.childNodes) {
                traverse(child)
                if (found) return
              }
              if (
                currentNode.nodeName === 'DIV' &&
                currentNode !== root &&
                currentNode.nextSibling
              ) {
                absoluteOffset += 1
              }
            }
          } else if (currentNode.nodeType === Node.TEXT_NODE) {
            absoluteOffset += currentNode.textContent?.length ?? 0
          }
        }

        traverse(root)
        return absoluteOffset
      }

      function getNodeAndOffset(absoluteOffset, root) {
        let currentOffset = 0

        function traverse(node) {
          if (node.nodeType === Node.TEXT_NODE) {
            const textLength = node.textContent?.length ?? 0
            if (currentOffset + textLength >= absoluteOffset) {
              return {
                node: node,
                offset: absoluteOffset - currentOffset,
              }
            }
            currentOffset += textLength
          } else if (node.nodeType === Node.ELEMENT_NODE) {
            if (node.nodeName === 'BR') {
              // âœ… BRä¸ç´¯åŠ offset
              if (currentOffset === absoluteOffset) {
                const parent = node.parentNode
                const index = Array.from(parent.childNodes).indexOf(node)
                return { node: parent, offset: index }
              }
            } else {
              for (const child of node.childNodes) {
                const result = traverse(child)
                if (result) return result
              }
              if (node.nodeName === 'DIV' && node !== root && node.nextSibling) {
                currentOffset += 1
              }
            }
          }
          return null
        }

        return traverse(root)
      }

      // æµ‹è¯•ç”¨ä¾‹
      const tests = [
        {
          name: 'æµ‹è¯•1: å•è¡Œæ–‡æœ¬ - å¾€è¿”ä¸€è‡´æ€§',
          html: '<div>Hello World</div>',
          testOffsets: [0, 5, 11],
        },
        {
          name: 'æµ‹è¯•2: å¤šè¡Œæ–‡æœ¬ - å¾€è¿”ä¸€è‡´æ€§',
          html: '<div>Hello</div><div>World</div>',
          testOffsets: [0, 5, 6, 11],
        },
        {
          name: 'æµ‹è¯•3: åŒ…å«ç©ºè¡Œ - å…³é”®æµ‹è¯•',
          html: '<div>Hello</div><div><br></div><div>World</div>',
          testOffsets: [0, 5, 6, 7, 12],
        },
        {
          name: 'æµ‹è¯•4: è¿ç»­ç©ºè¡Œ',
          html: '<div><br></div><div><br></div><div>Text</div>',
          testOffsets: [0, 1, 2, 6],
        },
        {
          name: 'æµ‹è¯•5: å¤æ‚åœºæ™¯ - ç©ºè¡Œåœ¨å„ä¸ªä½ç½®',
          html: '<div><br></div><div>A</div><div><br></div><div>B</div><div><br></div>',
          testOffsets: [0, 1, 2, 3, 4, 5],
        },
      ]

      const resultsContainer = document.getElementById('results')
      let passCount = 0
      let failCount = 0

      tests.forEach((test) => {
        const editor = document.createElement('div')
        editor.contentEditable = 'true'
        editor.innerHTML = test.html

        const textContent = getTextContent(editor)

        const testDiv = document.createElement('div')
        testDiv.className = 'test-case'

        let testHtml = `
        <div class="test-name">${test.name}</div>
        <div class="test-result">
          <span>HTML:</span>
          <code>${escapeHtml(test.html)}</code>
        </div>
        <div class="test-result">
          <span>Text Content:</span>
          <code>${escapeHtml(JSON.stringify(textContent))}</code>
        </div>
        <div class="test-result">
          <span>Length:</span>
          <code>${textContent.length}</code>
        </div>
        <div style="margin-top: 10px; font-weight: bold;">å¾€è¿”æµ‹è¯•ç»“æœ:</div>
      `

        let allPassed = true

        test.testOffsets.forEach((offset) => {
          // å¾€è¿”æµ‹è¯•ï¼šoffset -> node -> offset
          const nodeInfo = getNodeAndOffset(offset, editor)

          if (!nodeInfo) {
            failCount++
            allPassed = false
            testHtml += `
            <div class="test-result">
              <span class="fail">Offset ${offset}:</span>
              <code class="fail">âŒ getNodeAndOffsetè¿”å›null</code>
            </div>
          `
            return
          }

          const returnedOffset = getAbsoluteOffset(nodeInfo.node, nodeInfo.offset, editor)
          const passed = returnedOffset === offset

          if (passed) passCount++
          else {
            failCount++
            allPassed = false
          }

          const char = textContent[offset]
          const displayChar = char === '\n' ? '\\n' : char === undefined ? '(end)' : char

          testHtml += `
          <div class="test-result">
            <span class="${passed ? 'pass' : 'fail'}">Offset ${offset} â†’ "${displayChar}":</span>
            <code class="${passed ? 'pass' : 'fail'}">
              ${
                passed
                  ? `âœ… å¾€è¿”ä¸€è‡´ (node: ${nodeInfo.node.nodeName}, offset: ${nodeInfo.offset})`
                  : `âŒ è¿”å› ${returnedOffset} (expected ${offset})`
              }
            </code>
          </div>
        `
        })

        if (!allPassed) {
          testDiv.classList.add('fail')
        }

        testDiv.innerHTML = testHtml
        resultsContainer.appendChild(testDiv)
        editor.remove()
      })

      // æ˜¾ç¤ºæ‘˜è¦
      const summary = document.getElementById('summary')
      const totalTests = tests.reduce((sum, t) => sum + t.testOffsets.length, 0)
      summary.innerHTML = `
      <h3>æµ‹è¯•æ‘˜è¦</h3>
      <div style="font-size: 16px; margin: 10px 0;">
        æ€»è®¡: ${totalTests}<br>
        <span class="pass">âœ… é€šè¿‡: ${passCount}</span><br>
        <span class="fail">âŒ å¤±è´¥: ${failCount}</span>
      </div>
      <div style="font-size: 20px; font-weight: bold; margin-top: 15px;">
        ${failCount === 0 ? '<span class="pass">å…¨éƒ¨é€šè¿‡! ğŸ‰</span>' : '<span class="fail">æœ‰æµ‹è¯•å¤±è´¥</span>'}
      </div>
    `

      function escapeHtml(text) {
        const div = document.createElement('div')
        div.textContent = text
        return div.innerHTML
      }
    </script>
  </body>
</html>
