<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>markdownToHtml 测试</title>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
      }
      textarea {
        width: 100%;
        height: 200px;
        margin: 10px 0;
      }
      .output {
        border: 1px solid #ccc;
        padding: 15px;
        background: #f9f9f9;
      }
      button {
        padding: 10px 20px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <h1>markdownToHtml 测试</h1>
    <h3>输入 Markdown:</h3>
    <textarea id="input">
## 1. 段落格式

# 一级标题
## 二级标题
### 三级标题

> 这是一个引用块

---
## 2. 行内格式

- **粗体**
- *斜体* & _这也是斜体_
- `inline code`
- ==高亮==
- [外部链接](https://baidu.com)
- [内部链接](./roundtrip-test.html)
- [带标题](<https://google.com "搜索引擎">)

--- 
## 3. 插入Block

```python
block code
```

| 列1 | 列2 |
| --- | --- |
|  aa |  bb |

1. 图片：?
2. 视频：?
3. 嵌入链接：
4. 分割线

    </textarea>

    <button onclick="convert()">转换</button>

    <h3>输出 HTML:</h3>
    <div class="output" id="output"></div>

    <h3>渲染效果：</h3>
    <div class="output" id="preview"></div>

    <script type="module">
      // 从 CDN 导入
      import { marked } from 'https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js'
      import DOMPurify from 'https://cdn.jsdelivr.net/npm/dompurify@3.0.6/+esm'

      marked.setOptions({
        gfm: true, // GitHub Flavored Markdown
        breaks: true, // 换行转 <br>
      })

      const renderer = new marked.Renderer()
      renderer.link = function ({ href, title, tokens }) {
        const text = this.parser.parseInline(tokens)
        // 判断是否为外部链接
        const isExternal = href.startsWith('http')

        const titleAttr = title ? ` title="${title}"` : ''
        const targetAttr = isExternal ? ' target="_blank" rel="noopener noreferrer"' : ''

        return `<a href="${href}"${titleAttr}${targetAttr}>${text}</a>`
      }
      marked.setOptions({ renderer })

      function markdownToHtml(markdown) {
        // 1. Markdown → HTML
        const rawHtml = marked(markdown)

        // 2. 清理 HTML (防止XSS攻击)
        const cleanHtml = DOMPurify.sanitize(rawHtml, {
          ALLOWED_TAGS: [
            // 标题（只支持3级）
            'h1',
            'h2',
            'h3',
            // 段落和换行
            'p',
            'br',
            'hr',
            // 文本格式
            'strong',
            'em',
            'code',
            'pre',
            'del',
            // 引用
            'blockquote',
            // 列表
            'ul',
            'ol',
            'li',
            // 链接和图片
            'a',
            'img',
            // 表格
            'table',
            'thead',
            'tbody',
            'tr',
            'th',
            'td',
          ],
          ALLOWED_ATTR: ['href', 'src', 'alt', 'title', 'class', 'target', 'rel'],
        })

        return cleanHtml
      }

      // 使用
      window.convert = function () {
        const markdown = document.getElementById('input').value
        const html = markdownToHtml(markdown)
        document.getElementById('output').textContent = html
        document.getElementById('preview').innerHTML = html
      }

      // 自动转换一次
      convert()
    </script>
  </body>
</html>
